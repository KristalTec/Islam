<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Û•Ø±Û•Ú©ÛŒ - Islam Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        * { -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        :root { --bg-color: #fffbf2; --border-color: #d4af37; --highlight-color: #27ae60; --text-color: #2c3e50; --nav-bg: #ffffff; }
        body { font-family: 'Amiri', serif; background-color: #f8f9fa; margin: 0; padding: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 600px; background-color: var(--bg-color); height: 100%; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        /* Header */
        .header { background: white; padding: 15px; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; color: var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 50; }
        .icon-group { display: flex; gap: 15px; z-index: 10; }
        .header-btn { cursor: pointer; font-size: 22px; padding: 5px; transition: 0.3s; position: relative; }
        .header-btn:hover { transform: scale(1.1); color: #b6962f; }
        .notif-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: red; border-radius: 50%; border: 1px solid white; display: none; }
        .content { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; scroll-behavior: smooth; }
        .hero-card { background: linear-gradient(135deg, var(--border-color), #f1c40f); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4); position: relative; overflow: hidden; }
        .hero-title { font-size: 24px; margin-bottom: 10px; position: relative; z-index: 2; }
        .hero-date { font-size: 16px; opacity: 0.9; position: relative; z-index: 2; }
        .hero-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; background-image: url('https://www.transparenttextures.com/patterns/arabesque.png'); }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .card { background: white; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #eee; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-decoration: none; color: var(--text-color); }
        .card:active { transform: scale(0.95); background-color: #fffbf2; }
        .card-icon { font-size: 32px; }
        .card-title { font-weight: bold; font-size: 18px; }
        .feed-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .feed-title { font-size: 18px; font-weight: bold; color: var(--border-color); display: flex; align-items: center; gap: 8px; }
        .live-indicator { width: 8px; height: 8px; background: red; border-radius: 50%; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .feed-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; transition: 0.5s; position: relative; overflow: hidden; animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .feed-tag { position: absolute; top: 10px; left: 10px; font-size: 10px; padding: 3px 8px; border-radius: 10px; color: white; font-weight: bold; }
        .tag-ayah { background: var(--highlight-color); } 
        .tag-hadith { background: #3498db; } 
        .tag-dua { background: #e67e22; } 
        .tag-info { background: #9b59b6; } 
        .tag-name { background: #e74c3c; } 
        .feed-content { font-size: 17px; line-height: 1.8; color: #444; margin-top: 15px; text-align: justify; }
        .feed-source { font-size: 12px; color: #888; margin-top: 10px; display: block; font-style: italic; border-top: 1px dashed #eee; padding-top: 5px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--border-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid var(--border-color); animation: popUp 0.3s ease; position: relative; max-height: 80vh; overflow-y: auto; }
        .stat-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .user-list { max-height: 200px; overflow-y: auto; margin-top: 10px; text-align: right; border: 1px solid #f0f0f0; padding: 5px; border-radius: 5px; display: none; }
        .user-item { padding: 10px; background: #f9f9f9; margin-bottom: 5px; border-radius: 5px; display: flex; align-items: center; font-size: 12px; justify-content: space-between; border-bottom: 2px solid #eee; }
        .user-details { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        .user-ip { font-family: monospace; color: #555; direction: ltr; font-size: 11px; }
        .user-loc { color: #d35400; font-weight: bold; font-size: 10px; direction: ltr; }
        .gps-link { background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; text-decoration: none; font-size: 10px; margin-top: 2px; display: inline-block;}
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .dot.online { background: #27ae60; box-shadow: 0 0 5px #27ae60; }
        .history-list { max-height: 300px; overflow-y: auto; text-align: right; margin-top: 10px; }
        .history-item { background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 8px; border-right: 3px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: bold; font-size: 16px; color: var(--text-color); }
        .h-time { font-size: 11px; color: #888; }
        .clear-btn { background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; margin-top: 10px; }
        .notif-toggle-btn { padding: 10px; font-size: 14px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; text-align: center; font-weight: bold; width: 100%; transition: 0.3s; border: 1px solid transparent; }
        .notif-enabled { background: #e8f8f5; color: #27ae60; border-color: #27ae60; }
        .notif-disabled { background: #fdedec; color: #c0392b; border-color: #c0392b; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .social-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
        .social-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #f9f9f9; border: 1px solid #ddd; transition: 0.2s; }
        .social-btn img { width: 22px; height: 22px; }
        .social-btn:hover { transform: translateY(-3px); border-color: var(--border-color); background: #fffbf2; }
        .bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--nav-bg); height: 70px; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { text-decoration: none; display: flex; flex-direction: column; align-items: center; color: #999; font-size: 12px; gap: 5px; transition: 0.2s; width: 33.33%; }
        .nav-item.active { color: var(--border-color); font-weight: bold; }
        .nav-icon { font-size: 24px; }
        .nav-item:active { transform: scale(0.9); }
        .admin-badge { background: #e74c3c; color: white; padding: 2px 5px; border-radius: 4px; font-size: 10px; display: none; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="app-container">
        <audio id="notif-sound" src="https://www.islamcan.com/audio/adhan/bismillah.mp3" preload="auto"></audio>

        <div class="header">
            <div class="icon-group">
                <div class="header-btn" onclick="openSettings()" title="Ú•ÛÚ©Ø®Ø³ØªÙ†">âš™ï¸</div>
                <div class="header-btn" onclick="openHistory()" title="Ù…ÛÚ˜ÙˆÙˆ">
                    ğŸ•’
                    <span class="notif-badge" id="history-badge"></span>
                </div>
            </div>
            <div style="font-weight:bold; font-size:18px; cursor:pointer;" onclick="triggerAdminLogin()">
                Islam Online <span id="admin-indicator" class="admin-badge">Admin</span>
            </div>
            <div class="header-btn" onclick="triggerManualUpdate()" title="Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•">ğŸ”ƒ</div>
        </div>

        <div class="content">
            <div class="hero-card">
                <div class="hero-pattern"></div>
                <div class="hero-title">Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª</div>
                <div class="hero-date" id="current-date">...</div>
            </div>

            <div class="menu-grid">
                <a href="quran.html" class="card">
                    <div class="card-icon">ğŸ“–</div>
                    <div class="card-title">Ù‚ÙˆØ±Ø¦Ø§Ù†ÛŒ Ù¾ÛŒØ±Û†Ø²</div>
                </a>
                <a href="daily.html" class="card">
                    <div class="card-icon">ğŸ•Œ</div>
                    <div class="card-title">Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ù†Ú¯</div>
                </a>
                <a href="daily.html" class="card">
                    <div class="card-icon">âœ¨</div>
                    <div class="card-title">ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•</div>
                </a>
            </div>

            <div class="feed-header">
                <div class="feed-title">
                    <span class="live-indicator"></span>
                    <span>Ù†ÙˆÛØªØ±ÛŒÙ† Ø¨Ø§Ø¨Û•ØªÛ•Ú©Ø§Ù†</span>
                </div>
                <span style="font-size:12px; color:#888;">Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†</span>
            </div>
            
            <div id="feed-container">
                <div class="loader"></div>
            </div>
            
            <div style="margin-top: 30px; text-align: center; color: #ccc; font-size: 12px;">
                Made by Muhamad Ibrahim Rasul
            </div>
        </div>

        <div class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <span class="nav-icon">ğŸ </span>
                <span>Ø³Û•Ø±Û•Ú©ÛŒ</span>
            </a>
            <a href="quran.html" class="nav-item">
                <span class="nav-icon">ğŸ“–</span>
                <span>Ù‚ÙˆØ±Ø¦Ø§Ù†</span>
            </a>
            <a href="daily.html" class="nav-item">
                <span class="nav-icon">ğŸ•Œ</span>
                <span>Ø¨Ø§Ù†Ú¯ Ùˆ ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•</span>
            </a>
        </div>
    </div>

    <div id="settingsModal" class="modal" onclick="closeModal(event, 'settingsModal')">
        <div class="modal-content">
            <h3>âš™ï¸ Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù†</h3>
            
            <div id="notif-toggle-btn" class="notif-toggle-btn notif-disabled" onclick="toggleNotifications()">
                ğŸ”” Ú©Ø±ØªÛ• Ø¨Ú©Û• Ø¨Û† Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù†
            </div>

            <div class="stat-row">
                <span>Ø³Û•Ø±Ø¯Ø§Ù†ÛŒ ØªÛ†:</span>
                <b id="visit-count">0</b>
            </div>
            <div class="stat-row">
                <span>Ø¦Û†Ù†ÚµØ§ÛŒÙ† Ù„Û• Ø¬ÛŒÙ‡Ø§Ù†Ø¯Ø§:</span>
                <b id="active-count" style="color:var(--highlight-color);">...</b>
            </div>
            
            <div class="stat-row" style="background:#f0f0f0; border-radius:5px; margin-top:5px; font-size:10px;">
                <span>ID-ÛŒ Ø¦Ø§Ù…ÛØ±Û•Ú©Û•Øª:</span>
                <b id="my-device-id" style="font-family:monospace;">...</b>
            </div>

            <div id="admin-section" style="display:none;">
                <div style="text-align:right; margin-top:15px; font-weight:bold; font-size:14px; color:#c0392b; border-top:1px dashed #ddd; padding-top:10px;">
                    ğŸ”’ Ù¾Ø§Ù†ÛÚµÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†:
                </div>
                <div class="user-list" id="users-list-container" style="display:block;">
                    <div style="text-align:center; padding:10px;">Ø¬Ø§Ø±ÛŒ Ø¯Û•Ú©Ø±ÛØª...</div>
                </div>
                <button onclick="logoutAdmin()" style="width:100%; margin-top:5px; background:#e74c3c; color:white; border:none; padding:5px; border-radius:5px; cursor:pointer;">Ú†ÙˆÙˆÙ†Û• Ø¯Û•Ø±Û•ÙˆÛ• Ù„Û• Ø¦Û•Ø¯Ù…ÛŒÙ†</button>
            </div>

            <div style="margin-top:20px; font-weight:bold; color:var(--border-color); border-bottom: 1px solid #eee;">ğŸ“ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ</div>
            <div class="social-row" style="margin-top:10px;">
                <a href="https://facebook.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg"></a>
                <a href="https://instagram.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e7/Instagram_logo_2016.svg"></a>
                <a href="https://snapchat.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/en/c/c4/Snapchat_logo.svg"></a>
                <a href="https://tiktok.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/en/a/a9/TikTok_logo.svg"></a>
            </div>

            <button onclick="document.getElementById('settingsModal').style.display='none'" style="margin-top:20px; padding:8px 20px; background:var(--border-color); color:white; border:none; border-radius:5px; cursor:pointer;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="historyModal" class="modal" onclick="closeModal(event, 'historyModal')">
        <div class="modal-content">
            <h3>ğŸ•’ Ù…ÛÚ˜ÙˆÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•</h3>
            <div id="history-list-container" class="history-list"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆÛŒ</button>
                <button onclick="document.getElementById('historyModal').style.display='none'" style="padding:8px 20px; background:var(--border-color); color:white; border:none; border-radius:5px; cursor:pointer;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // ğŸ”’ SECURITY CONFIGURATION
        // ===========================================
        const ALLOWED_DEVICE_ID = "u_enqmvr2ay"; 
        // ===========================================

        // Set Date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('ar-IQ', options);

        // Define My ID
        let myId = localStorage.getItem('unique_device_id');
        if (!myId) { myId = 'u_' + Math.random().toString(36).substr(2, 8); localStorage.setItem('unique_device_id', myId); }
        document.getElementById('my-device-id').innerText = myId;

        // UI Functions
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; updateStatsUI(); }
        function openHistory() { document.getElementById('historyModal').style.display = 'flex'; renderHistory(); }
        function closeModal(e, id) { if (e.target.id === id) { document.getElementById(id).style.display = 'none'; } }

        // ===========================================
        // ADMIN SYSTEM
        // ===========================================
        let adminClicks = 0;
        let isAdmin = localStorage.getItem('site_admin_access') === 'true';

        if(isAdmin && myId !== ALLOWED_DEVICE_ID) {
            console.log("Unauthorized device detected. Logging out.");
            logoutAdmin(false); 
        }

        if(isAdmin && myId === ALLOWED_DEVICE_ID) {
            document.getElementById('admin-section').style.display = 'block';
            document.getElementById('admin-indicator').style.display = 'inline-block';
        }

        function triggerAdminLogin() {
            adminClicks++;
            if(adminClicks === 5) {
                adminClicks = 0;
                if(isAdmin) return; 

                const pass = prompt("ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•:");
                
                if(pass === "SD@26cQcatggBBMD$531578FbnmfsWronsTyygsBc53&") { 
                    
                    if (myId === ALLOWED_DEVICE_ID) {
                        localStorage.setItem('site_admin_access', 'true');
                        isAdmin = true;
                        document.getElementById('admin-section').style.display = 'block';
                        document.getElementById('admin-indicator').style.display = 'inline-block';
                        alert("Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª Ø¨Û•Ú•ÛØ² Ø¦Û•Ø¯Ù…ÛŒÙ† âœ…");
                        updateStatsUI();
                    } else {
                        alert("âš ï¸ Ù‡Û•ÚµÛ•: Ø¦Û•Ù… Ø¦Ø§Ù…ÛØ±Û• Ú•ÛÚ¯Û•Ù¾ÛØ¯Ø±Ø§Ùˆ Ù†ÛŒÛŒÛ• Ø¨Û† Ø¦Û•Ø¯Ù…ÛŒÙ†.\nID-ÛŒ Ø¦Û•Ù… Ø¦Ø§Ù…ÛØ±Û•: " + myId);
                    }
                } else {
                    alert("ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ• âŒ");
                }
            }
        }

        function logoutAdmin(showAlert = true) {
            localStorage.setItem('site_admin_access', 'false');
            isAdmin = false;
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('admin-indicator').style.display = 'none';
            if(showAlert) {
                alert("Ù…Ø§ÚµØ¦Ø§ÙˆØ§ Ø¦Û•Ø¯Ù…ÛŒÙ† ğŸ‘‹");
                location.reload();
            }
        }

        // ===========================================
        // NOTIFICATIONS
        // ===========================================
        let isNotifActive = JSON.parse(localStorage.getItem('isNotifActive') || 'false');
        let feedData = JSON.parse(localStorage.getItem('islam_feed_data') || '[]');

        function updateNotifUI() {
            const btn = document.getElementById('notif-toggle-btn');
            if (isNotifActive) {
                btn.innerHTML = "ğŸ”• Ú©Ø±ØªÛ• Ø¨Ú©Û• Ø¨Û† Ù†Ø§Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù†";
                btn.className = "notif-toggle-btn notif-enabled";
            } else {
                btn.innerHTML = "ğŸ”” Ú©Ø±ØªÛ• Ø¨Ú©Û• Ø¨Û† Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù†";
                btn.className = "notif-toggle-btn notif-disabled";
            }
        }

        function toggleNotifications() {
            if (isNotifActive) {
                isNotifActive = false;
                localStorage.setItem('isNotifActive', 'false');
                alert("âŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù† Ú•Ø§Ú¯ÛŒØ±Ø§");
                updateNotifUI();
            } else {
                const audio = document.getElementById('notif-sound');
                audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(e => console.log("Audio unlock failed", e));
                if ("Notification" in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            isNotifActive = true;
                            localStorage.setItem('isNotifActive', 'true');
                            alert("âœ… Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù† Ú†Ø§Ù„Ø§Ú© Ú©Ø±Ø§");
                            updateNotifUI();
                            startLiveUpdates();
                        }
                    });
                }
            }
        }

        function saveFeed() { localStorage.setItem('islam_feed_data', JSON.stringify(feedData)); }
        
        async function loadInitialFeed() {
            const container = document.getElementById('feed-container');
            container.innerHTML = ''; 
            if(feedData.length > 0) {
                feedData.forEach(item => { renderCard(item.type, item.content, item.isNew); });
            } else {
                addCardToFeed('hadith', getRandom(db.hadiths), false, true);
                await addAyahCard();
                addCardToFeed('info', getRandom(db.info), false, true);
            }
        }

        function addCardToFeed(type, content, isNew = false, save = true) {
            renderCard(type, content, isNew);
            if (save) {
                feedData.unshift({ type, content, isNew });
                if(feedData.length > 1000) feedData.pop();
                saveFeed();
            }
        }

        function renderCard(type, content, isNew) {
            const container = document.getElementById('feed-container');
            const div = document.createElement('div');
            div.className = 'feed-card';
            let tagHTML = '', sourceHTML = '', displayContent = content;
            if (type === 'hadith') { tagHTML = '<span class="feed-tag tag-hadith">ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•</span>'; sourceHTML = 'Ù¾ÛØºÛ•Ù…Ø¨Û•Ø± (Ø¯.Ø®) Ø¯Û•ÙÛ•Ø±Ù…ÙˆÛØª'; } 
            else if (type === 'dua') { tagHTML = '<span class="feed-tag tag-dua">Ø¯ÙˆØ¹Ø§ÛŒ Ú•Û†Ú˜</span>'; sourceHTML = 'Ø¯ÙˆØ¹Ø§ Ùˆ Ù¾Ø§Ú•Ø§Ù†Û•ÙˆÛ•'; } 
            else if (type === 'name') { tagHTML = '<span class="feed-tag tag-name">Ù†Ø§ÙˆÛŒ Ø®ÙˆØ§ÛŒ Ú¯Û•ÙˆØ±Û•</span>'; displayContent = `<b>${content.name}</b>: ${content.meaning}`; sourceHTML = 'Ø¦Û•Ø³Ù…Ø§Ø¦ÛŒ Ø­ÙˆØ³Ù†Ø§'; } 
            else if (type === 'info') { tagHTML = '<span class="feed-tag tag-info">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ</span>'; sourceHTML = 'Ø±Û†Ø´Ù†Ø¨ÛŒØ±ÛŒ Ø¦ÛŒØ³Ù„Ø§Ù…ÛŒ'; } 
            else if (type === 'ayah') { tagHTML = '<span class="feed-tag tag-ayah">Ø¦Ø§ÛŒÛ•ØªÛŒ Ú•Û†Ú˜</span>'; sourceHTML = content.source; displayContent = `"${content.text}"`; }
            div.innerHTML = `${tagHTML}<div class="feed-content">${displayContent}</div><span class="feed-source">${sourceHTML} ${isNew ? 'â€¢ <span style="color:red">ØªØ§Ø²Û•</span>' : ''}</span>`;
            if (container.children.length > 0 && isNew) { container.insertBefore(div, container.firstChild); } else { container.appendChild(div); }
        }

        async function addAyahCard() {
            try {
                const randomId = Math.floor(Math.random() * 6236) + 1;
                const r = await fetch(`https://api.alquran.cloud/v1/ayah/${randomId}/editions/quran-uthmani`);
                const d = await r.json();
                addCardToFeed('ayah', { text: d.data[0].text, source: `Ø³ÙˆØ±Ø© ${d.data[0].surah.name}` }, false, true);
            } catch(e) { console.log("Ayah fetch error"); }
        }

        function startLiveUpdates() { setInterval(() => { triggerManualUpdate(); }, 12000); }
        function triggerManualUpdate() {
            const types = ['hadith', 'dua', 'name', 'info'];
            const type = types[Math.floor(Math.random() * types.length)];
            let content;
            if(type === 'name') content = getRandom(db.names); else content = getRandom(db[type + 's'] || db[type]); 
            addCardToFeed(type, content, true, true);
            if (isNotifActive) {
                let notifTitle = "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù†ÙˆÛ", notifBody = "";
                if (type === 'hadith') { notifTitle = "ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•"; notifBody = content.substring(0, 100) + "..."; }
                else if (type === 'dua') { notifTitle = "Ø¯ÙˆØ¹Ø§"; notifBody = content.substring(0, 100); }
                else if (type === 'name') { notifTitle = "Ù†Ø§ÙˆÛŒ Ø®ÙˆØ§ÛŒ Ú¯Û•ÙˆØ±Û•"; notifBody = `${content.name}: ${content.meaning}`; }
                else if (type === 'info') { notifTitle = "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ"; notifBody = content; }
                playNotification(notifTitle, notifBody);
            }
        }

        function playNotification(title, body) {
            const audio = document.getElementById('notif-sound');
            audio.currentTime = 0; audio.play().catch(e => console.log("Audio still locked"));
            if("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
            if (Notification.permission === "granted") { new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/2884/2884657.png", requireInteraction: false }); }
        }
        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        // Data DB
        const db = {
            hadiths: ["Ù¾ÛØºÛ•Ù…Ø¨Û•Ø± (Ø¯.Ø®) Ø¯Û•ÙÛ•Ø±Ù…ÙˆÛØª: Ø¨Ø§Ø´ØªØ±ÛŒÙ†ØªØ§Ù† Ø¦Û•ÙˆÛ•ÛŒÛ• Ú©Û• Ù‚ÙˆØ±Ø¦Ø§Ù† ÙÛØ± Ø¯Û•Ø¨ÛØª Ùˆ ÙÛØ±ÛŒ Ø®Û•ÚµÚ©ÛŒØ´ÛŒ Ø¯Û•Ú©Ø§Øª.", "Ù¾ÛÚ©Û•Ù†ÛŒÙ† Ø¨Û• Ú•ÙˆÙˆÛŒ Ø¨Ø±Ø§Ú©Û•ØªØ¯Ø§ Ø³Û•Ø¯Û•Ù‚Û•ÛŒÛ•.", "Ù¾Ø§Ú©ÙˆØ®Ø§ÙˆÛÙ†ÛŒ Ø¨Û•Ø´ÛÚ©Û• Ù„Û• Ø¦ÛŒÙ…Ø§Ù†.", "Ú©Û•Ø³ÛÚ©ØªØ§Ù† Ø¦ÛŒÙ…Ø§Ù†ÛŒ ØªÛ•ÙˆØ§Ùˆ Ù†ÛŒÛŒÛ• ØªØ§ Ø¦Û•ÙˆÛ•ÛŒ Ø¨Û† Ø®Û†ÛŒ Ù¾ÛÛŒ Ø®Û†Ø´Û• Ø¨Û† Ø¨Ø±Ø§Ú©Û•Ø´ÛŒ Ù¾ÛÛŒ Ø®Û†Ø´ Ù†Û•Ø¨ÛØª."],
            duas: ["Ø±ÙØ¨ÙÙ‘Ù†ÙØ§ Ø¢ØªÙÙ†ÙØ§ ÙÙÙŠ Ø§Ù„Ø¯ÙÙ‘Ù†Ù’ÙŠÙØ§ Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙÙÙŠ Ø§Ù„Ø¢Ø®ÙØ±ÙØ©Ù Ø­ÙØ³ÙÙ†ÙØ©Ù‹", "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø§Ù„Ù‡Ø¯Ù‰ ÙˆØ§Ù„ØªÙ‚Ù‰ ÙˆØ§Ù„Ø¹ÙØ§Ù ÙˆØ§Ù„ØºÙ†Ù‰", "ÙŠØ§ Ù…Ù‚Ù„Ø¨ Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø«Ø¨Øª Ù‚Ù„Ø¨ÙŠ Ø¹Ù„Ù‰ Ø¯ÙŠÙ†Ùƒ", "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†Ùƒ Ø¹ÙÙˆ ØªØ­Ø¨ Ø§Ù„Ø¹ÙÙˆ ÙØ§Ø¹Ù Ø¹Ù†ÙŠ"],
            names: [{ name: "Ø§Ù„Ø±Ø­Ù…Ù†", meaning: "Ø¨Û•Ø®Ø´Ù†Ø¯Û•" }, { name: "Ø§Ù„Ø±Ø­ÙŠÙ…", meaning: "Ø¨Û•Ø¨Û•Ø²Û•ÛŒÛŒ" }, { name: "Ø§Ù„Ù…Ù„Ùƒ", meaning: "Ù¾Ø§Ø´Ø§" }, { name: "Ø§Ù„Ù‚Ø¯ÙˆØ³", meaning: "Ù¾Ø§Ú©" }],
            info: ["ÛŒÛ•Ú©Û•Ù… Ù…Ø²Ú¯Û•ÙˆØª Ù„Û• Ø¦ÛŒØ³Ù„Ø§Ù…Ø¯Ø§ Ù…Ø²Ú¯Û•ÙˆØªÛŒ Ù‚ÙˆØ¨Ø§Ø¦Û•.", "Ù‚ÙˆØ±Ø¦Ø§Ù†ÛŒ Ù¾ÛŒØ±Û†Ø² Ù„Û• Ù¡Ù¡Ù¤ Ø³ÙˆØ±Û•Øª Ù¾ÛÚ©Ù‡Ø§ØªÙˆÙˆÛ•.", "Ø¯Ø±ÛÚ˜ØªØ±ÛŒÙ† Ø³ÙˆØ±Û•ØªÛŒ Ù‚ÙˆØ±Ø¦Ø§Ù† Ø³ÙˆØ±Û•ØªÛŒ Ø¨Û•Ù‚Û•Ø±Û•ÛŒÛ•."]
        };

        function renderHistory() {
            const container = document.getElementById('history-list-container');
            const history = JSON.parse(localStorage.getItem('quran_history') || '[]');
            container.innerHTML = history.length ? '' : '<div style="text-align:center; color:#999; padding:20px;">Ù‡ÛŒÚ† Ù…ÛÚ˜ÙˆÙˆÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</div>';
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div class="h-info"><span class="h-name">ğŸ“– ${item.name}</span><span class="h-time">${item.date}</span></div>`;
                container.appendChild(div);
            });
        }
        function clearHistory() { if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØŸ")) { localStorage.removeItem('quran_history'); renderHistory(); } }

        // ===========================================
        // REAL-TIME ONLINE SYSTEM & PRECISE LOCATION
        // ===========================================
        
        if (!sessionStorage.getItem('session_counted')) {
            let visits = localStorage.getItem('total_site_visits') || 0;
            visits = parseInt(visits) + 1;
            localStorage.setItem('total_site_visits', visits);
            sessionStorage.setItem('session_counted', 'true');
        }
        document.getElementById('visit-count').innerText = localStorage.getItem('total_site_visits');

        const deviceType = /Mobi|Android/i.test(navigator.userAgent) ? "ğŸ“± Ù…Û†Ø¨Ø§ÛŒÙ„" : "ğŸ’» Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±";
        let myIP = "Loading...";
        let myLocation = "Ù†Û•Ø²Ø§Ù†Ø±Ø§Ùˆ";
        let myGPSLink = ""; // To store precise location link
        let onlineUsers = new Map();
        let socket;
        
        async function fetchIPandLocation() {
            // 1. Get Rough IP Location First
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                myIP = data.ip || "Unknown";
                myLocation = (data.city ? data.city : "") + " - " + (data.country_name ? data.country_name : "");
                if(myLocation === " - ") myLocation = "Ø´ÙˆÛÙ† Ù†Ø§Ø¯ÛŒØ§Ø±Û•";
            } catch (e) {
                myIP = "Unknown";
                myLocation = "Unknown Location";
            }

            // 2. Try to get 100% Accurate GPS Location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Success: User allowed GPS
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        myGPSLink = `https://www.google.com/maps?q=${lat},${lng}`;
                        // Re-connect to send updated GPS info
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            broadcastPresence(); 
                        }
                    },
                    (error) => {
                        console.log("GPS denied or error: " + error.message);
                    }
                );
            }

            connectToSignalingServer();
        }

        function connectToSignalingServer() {
            const apiKey = 'VCXCEuvhGcBDP7XhiJJUDvR1e1D3eiVjgZ9VRiaV';
            const channelId = '1'; 
            socket = new WebSocket(`wss://demo.piesocket.com/v3/channel_${channelId}?api_key=${apiKey}&notify_self=1`);

            socket.onopen = () => {
                broadcastPresence();
                setInterval(broadcastPresence, 3000); 
                setInterval(cleanOfflineUsers, 5000);
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'presence') {
                        onlineUsers.set(data.id, {
                            ...data,
                            lastSeen: Date.now()
                        });
                        updateStatsUI();
                    }
                } catch (e) {}
            };
            
            socket.onclose = () => { setTimeout(connectToSignalingServer, 5000); };
        }

        function broadcastPresence() {
            if(socket && socket.readyState === WebSocket.OPEN) {
                const payload = JSON.stringify({
                    type: 'presence',
                    id: myId,
                    device: deviceType,
                    ip: myIP,
                    location: myLocation,
                    gps: myGPSLink, // Send the GPS link
                    timestamp: Date.now()
                });
                socket.send(payload);
            }
        }

        function cleanOfflineUsers() {
            const now = Date.now();
            let changed = false;
            onlineUsers.forEach((user, id) => {
                if (now - user.lastSeen > 10000) {
                    onlineUsers.delete(id);
                    changed = true;
                }
            });
            if (changed) updateStatsUI();
        }

        function updateStatsUI() {
            const list = document.getElementById('users-list-container');
            const countLabel = document.getElementById('active-count');
            list.innerHTML = '';
            
            let count = onlineUsers.size;
            if (count === 0) count = 1; 
            countLabel.innerText = count;

            if (!isAdmin) {
                return; 
            }

            const sortedUsers = Array.from(onlineUsers.values()).sort((a,b) => (a.id === myId ? -1 : 1));

            if (sortedUsers.length === 0) {
                 list.appendChild(createUserElement(myId, deviceType, myIP, myLocation, myGPSLink, true));
            } else {
                sortedUsers.forEach(user => {
                    const isMe = user.id === myId;
                    list.appendChild(createUserElement(user.id, user.device, user.ip, user.location, user.gps, isMe));
                });
            }
        }

        function createUserElement(id, device, ip, loc, gps, isMe) {
            const div = document.createElement('div');
            div.className = 'user-item';
            
            let gpsHTML = '';
            if (gps && gps.length > 5) {
                gpsHTML = `<a href="${gps}" target="_blank" class="gps-link">ğŸ“ Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù†Û•Ø®Ø´Û•</a>`;
            }

            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="dot online"></span>
                    <span style="margin-right:10px; font-weight:bold;">${isMe ? 'ØªÛ† (Admin)' : 'Ù…ÛŒÙˆØ§Ù†'}</span>
                </div>
                <div class="user-details">
                    <span style="font-size:10px; color:#888;">${device}</span>
                    <span class="user-loc">${loc || "Ù†Û•Ø²Ø§Ù†Ø±Ø§Ùˆ"}</span>
                    <span class="user-ip">${ip}</span>
                    ${gpsHTML}
                </div>
            `;
            return div;
        }

        loadInitialFeed();
        fetchIPandLocation(); 
        updateNotifUI();
    </script>
</body>
</html>
