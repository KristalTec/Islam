<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Made by Muhamad Ibrahim Rasul - Ultimate Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Ù‡Û•Ù…Ø§Ù† Ø³ØªØ§ÛŒÙ„Û•Ú©Ø§Ù†Øª ÙˆÛ•Ú© Ø®Û†ÛŒ */
        * { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        :root { --bg-color: #fffbf2; --border-color: #d4af37; --highlight-color: #27ae60; --dark-text: #2c3e50; }
        body { font-family: 'Amiri', serif; background-color: #f8f9fa; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #app-container { display: flex; }
        .main-container { width: 100%; max-width: 700px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 95vh; position: relative; overflow: hidden; }
        .header { background: white; padding: 10px; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding-left: 15px; padding-right: 15px; height: 60px; }
        .menu-btn { font-size: 28px; cursor: pointer; color: var(--border-color); padding: 5px; transition: 0.2s; }
        .menu-btn:hover { color: #b6962f; }
        select { font-family: 'Amiri', serif; font-size: 18px; padding: 5px; width: 65%; border: 1px solid #ddd; border-radius: 8px; outline: none; background: #fff; text-align: center; }
        .sidebar { position: absolute; top: 0; right: -100%; width: 75%; height: 100%; background: white; z-index: 100; transition: 0.4s ease; box-shadow: -5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .sidebar.open { right: 0; }
        .sidebar-header { padding: 20px; background: var(--border-color); color: white; display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; }
        .close-btn { cursor: pointer; font-size: 24px; }
        .menu-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .menu-section-title { font-size: 18px; color: var(--border-color); border-bottom: 1px solid #eee; margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; }
        .menu-item { background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; border: 1px solid #eee; transition: 0.2s; font-size: 16px; }
        .menu-item:hover { background: #fffbf2; border-color: var(--border-color); }
        .item-info { display: flex; flex-direction: column; }
        .item-date { font-size: 12px; color: #888; }
        .delete-item { color: red; cursor: pointer; font-size: 18px; padding: 0 5px; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
        .overlay.active { display: block; }
        .quran-content { flex-grow: 1; padding: 20px; overflow-y: auto; text-align: justify; font-size: 32px; line-height: 2.6; scroll-behavior: smooth; }
        .ayah-container { display: inline; }
        .word { display: inline-block; padding: 0 2px; border-radius: 4px; transition: all 0.1s ease; cursor: pointer; }
        .word.active { color: var(--highlight-color); font-weight: bold; text-shadow: 0 0 1px var(--highlight-color); transform: scale(1.1); background-color: rgba(39, 174, 96, 0.1); }
        .ayah-number { font-size: 18px; color: var(--border-color); border: 1px solid var(--border-color); border-radius: 50%; padding: 0 8px; margin: 0 5px; display: inline-block; vertical-align: middle; }
        .basmala { text-align: center; font-size: 26px; color: var(--border-color); margin-bottom: 20px; display: block; font-family: 'Amiri', serif; }
        .footer { background: white; padding: 15px; border-top: 1px solid #eee; border-radius: 0 0 15px 15px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.02); }
        #live-caption { width: 90%; background-color: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 16px; color: #555; margin-bottom: 12px; text-align: center; min-height: 25px; border: 1px solid #e0e0e0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; direction: rtl; }
        .controls { display: flex; gap: 15px; align-items: center; width: 100%; justify-content: center; }
        button#mic-btn { background-color: var(--border-color); color: white; border: none; padding: 12px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; font-family: 'Amiri', serif; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3); transition: transform 0.2s, background 0.3s; width: 180px; justify-content: center; }
        button#mic-btn:active { transform: scale(0.95); }
        button.listening { background-color: #e74c3c !important; animation: pulse 1.5s infinite; }
        button#fav-btn { background: white; border: 2px solid var(--border-color); color: var(--border-color); width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; }
        button#fav-btn:hover { background: var(--border-color); color: white; }
        .copyright { font-size: 10px; color: #aaa; margin-top: 10px; cursor: pointer; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.6); } 70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        /* ====================
           New Admin Dashboard Styles
           ==================== */
        #admin-panel {
            display: none; /* Hidden by default */
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; max-height: 400px; background: white; border: 2px solid var(--border-color);
            border-radius: 10px; z-index: 200; box-shadow: 0 0 20px rgba(0,0,0,0.3);
            overflow: hidden; flex-direction: column;
        }
        .admin-header { background: var(--border-color); color: white; padding: 10px; text-align: center; font-weight: bold; display: flex; justify-content: space-between; }
        .admin-content { padding: 10px; overflow-y: auto; font-size: 14px; }
        .user-row { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; align-items: center; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .online { background-color: #27ae60; }
        .offline { background-color: #e74c3c; }
        .idle { background-color: #f39c12; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="admin-panel">
        <div class="admin-header">
            <span>Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù† (Admin)</span>
            <span style="cursor:pointer" onclick="document.getElementById('admin-panel').style.display='none'">âœ•</span>
        </div>
        <div class="admin-content">
            <div style="text-align:center; font-weight:bold; margin-bottom:10px;">
                Ø¦Û†Ù†Ù„Ø§ÛŒÙ†: <span id="online-count">0</span>
            </div>
            <div id="users-list">Ø¬Ø§Ø±ÛŒ Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†...</div>
        </div>
    </div>

    <div class="main-container" id="app-container">
        
        <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>Ù„ÛŒØ³ØªÛŒ Ø³Û•Ø±Û•Ú©ÛŒ</span>
                <span class="close-btn" onclick="toggleMenu()">âœ•</span>
            </div>
            <div class="menu-content">
                <div class="menu-section-title">â¤ï¸ Ø¯ÚµØ®ÙˆØ§Ø²Û•Ú©Ø§Ù† (Bookmarks)</div>
                <div id="favorites-list"></div>

                <div class="menu-section-title">ğŸ•’ Ù…ÛÚ˜ÙˆÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•</div>
                <div id="history-list"></div>
                
                <div class="menu-section-title">ğŸ”§ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†</div>
                <div class="menu-item" onclick="document.getElementById('admin-panel').style.display='flex'; toggleMenu();">
                    <div class="item-info"><span>ğŸ“Š Ø¦Ø§Ù…Ø§Ø±ÛŒ Ø³Û•Ø±Ø¯Ø§Ù†ÛŒÚ©Û•Ø±Ø§Ù†</span></div>
                </div>
            </div>
        </div>

        <div class="header">
            <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
            <select id="surahSelect" onchange="loadSurah(this.value)">
                <option value="1" selected>1. Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©</option>
                <option value="" disabled>Ø¬Ø§Ø±ÛŒ Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†...</option>
            </select>
        </div>

        <div class="quran-content" id="quran-display"></div>

        <div class="footer">
            <div id="live-caption">Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ• Ø¨Û† Ú¯ÙˆÛÚ¯Ø±ØªÙ†...</div>
            <div class="controls">
                <button id="fav-btn" onclick="saveToFavorites()" title="Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†ÛŒ Ø¦Û•Ù… Ø´ÙˆÛÙ†Û•">â¤ï¸</button>
                <button id="mic-btn" onclick="toggleListening()">
                    <span>ğŸ¤</span> Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†
                </button>
            </div>
            <div class="copyright" onclick="toggleAdminSecret()">Made by Muhamad Ibrahim Rasul</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onDisconnect, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ==========================================
        // âš ï¸ Ù„ÛØ±Û• Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ FirebaseÙ€Û•Ú©Û•Øª Ø¯Ø§Ø¨Ù†Û âš ï¸
        // ==========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Tracking Logic ---
        let userId = localStorage.getItem('unique_visitor_id');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('unique_visitor_id', userId);
        }

        async function registerUser() {
            try {
                // Get Location info
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                const location = data.city ? `${data.city}, ${data.country_name}` : "Unknown Location";

                const userRef = ref(db, 'online_users/' + userId);

                // Set user data
                set(userRef, {
                    id: userId,
                    location: location,
                    status: 'online',
                    lastActive: Date.now()
                });

                // Handle Disconnect (Closing tab)
                onDisconnect(userRef).remove();

                // Handle Visibility Change (Active/Inactive)
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === 'visible') {
                        update(userRef, { status: 'online', lastActive: Date.now() });
                    } else {
                        update(userRef, { status: 'idle' });
                    }
                });

            } catch (err) {
                console.error("Tracking Error:", err);
            }
        }

        // --- Admin Panel Logic (Listen to DB) ---
        const usersListEl = document.getElementById('users-list');
        const onlineCountEl = document.getElementById('online-count');

        const allUsersRef = ref(db, 'online_users');
        onValue(allUsersRef, (snapshot) => {
            const data = snapshot.val();
            usersListEl.innerHTML = "";
            let count = 0;

            if (data) {
                Object.values(data).forEach(user => {
                    count++;
                    const statusClass = user.status === 'online' ? 'online' : 'idle';
                    const statusText = user.status === 'online' ? 'Ú†Ø§Ù„Ø§Ú©' : 'Ù†Ø§Ú†Ø§Ù„Ø§Ú©';
                    
                    const div = document.createElement('div');
                    div.className = 'user-row';
                    div.innerHTML = `
                        <div>
                            <span class="status-dot ${statusClass}"></span>
                            ${user.location || "Ù†Û•Ø²Ø§Ù†Ø±Ø§Ùˆ"}
                        </div>
                        <div style="font-size:12px; color:#666;">${statusText}</div>
                    `;
                    usersListEl.appendChild(div);
                });
            }
            onlineCountEl.innerText = count;
        });

        // Start Tracking
        registerUser();

    </script>

    <script>
        // ... (ØªÛ•ÙˆØ§ÙˆÛŒ Ú©Û†Ø¯Û• Ú©Û†Ù†Û•Ú©Û•Øª Ù„ÛØ±Û• Ø¯Û•Ù…ÛÙ†ÛØªÛ•ÙˆÛ• Ø¨Û• Ø¨Û Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ) ...
        // ... (Ø®ÙˆØ§Ø±Û•ÙˆÛ• Ú©Û†Ù¾ÛŒ Ø¨Ú©Û•Ø±Û•ÙˆÛ• Ø¨Û† ØªÛ•ÙˆØ§ÙˆÚ©Ø±Ø¯Ù†ÛŒ Ø³Ú©Ø±ÛŒÙ¾ØªÛ• Ú©Û†Ù†Û•Ú©Û•) ...

        // ==========================================
        // SECURITY SCRIPT
        // ==========================================
        document.onkeydown = function(e) {
            if(
                event.keyCode == 123 || 
                (event.ctrlKey && event.shiftKey && event.keyCode == 73) || 
                (event.ctrlKey && event.shiftKey && event.keyCode == 74) || 
                (event.ctrlKey && event.keyCode == 85)
            ) { return false; }
        }
        document.ondragstart = function() { return false; }; 

        // ==========================================
        // Data & Variables
        // ==========================================
        const fatihaData = [
            { text: "Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", numberInSurah: 1 },
            { text: "Ù±Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ù±Ù„Ù’Ø¹ÙÙ°Ù„ÙÙ…ÙÙŠÙ†Ù", numberInSurah: 2 },
            { text: "Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", numberInSurah: 3 },
            { text: "Ù…ÙÙ°Ù„ÙÙƒÙ ÙŠÙÙˆÙ’Ù…Ù Ù±Ù„Ø¯ÙÙ‘ÙŠÙ†Ù", numberInSurah: 4 },
            { text: "Ø¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ¹Ù’Ø¨ÙØ¯Ù ÙˆÙØ¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ³Ù’ØªÙØ¹ÙÙŠÙ†Ù", numberInSurah: 5 },
            { text: "Ù±Ù‡Ù’Ø¯ÙÙ†ÙØ§ Ù±Ù„ØµÙÙ‘Ø±ÙÙ°Ø·Ù Ù±Ù„Ù’Ù…ÙØ³Ù’ØªÙÙ‚ÙÙŠÙ…Ù", numberInSurah: 6 },
            { text: "ØµÙØ±ÙÙ°Ø·Ù Ù±Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø£ÙÙ†Ù’Ø¹ÙÙ…Ù’ØªÙ Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ØºÙÙŠÙ’Ø±Ù Ù±Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ÙˆÙÙ„ÙØ§ Ù±Ù„Ø¶ÙÙ‘Ø§Ù„ÙÙ‘ÙŠÙ†Ù", numberInSurah: 7 }
        ];

        let allAyahs = [];
        let currentAyahIndex = 0;
        let currentWordIndex = 0;
        let currentWords = []; 
        let isListening = false;
        let recognition;
        let currentSurahName = "Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©";
        let currentSurahNumber = 1;

        // UI Elements
        const surahSelect = document.getElementById('surahSelect');
        const quranDisplay = document.getElementById('quran-display');
        const captionBox = document.getElementById('live-caption');
        const micBtn = document.getElementById('mic-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const favoritesList = document.getElementById('favorites-list');
        const historyList = document.getElementById('history-list');

        // Admin Secret Toggle
        let clickCount = 0;
        function toggleAdminSecret() {
            clickCount++;
            if(clickCount === 5) {
                document.getElementById('admin-panel').style.display = 'flex';
                clickCount = 0;
            }
        }

        init();

        function init() {
            loadHistory();
            loadFavorites();
            if(allAyahs.length === 0) {
                allAyahs = fatihaData;
                renderSurah(1);
                prepareCurrentAyah();
                fetchSurahList();
                addToHistory(1, "Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©");
            }
        }

        // ==========================================
        // Menu & Storage Logic
        // ==========================================
        function toggleMenu() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            if(sidebar.classList.contains('open')) { loadHistory(); loadFavorites(); }
        }

        function addToHistory(surahNum, surahName) {
            let history = JSON.parse(localStorage.getItem('quran_history') || '[]');
            history = history.filter(h => h.number != surahNum);
            history.unshift({ number: surahNum, name: surahName, date: new Date().toLocaleDateString('ar-IQ') });
            if(history.length > 10) history.pop();
            localStorage.setItem('quran_history', JSON.stringify(history));
        }

        function saveToFavorites() {
            const ayahNum = allAyahs[currentAyahIndex].numberInSurah;
            let favorites = JSON.parse(localStorage.getItem('quran_favorites') || '[]');
            const newFav = {
                surahNum: currentSurahNumber,
                surahName: currentSurahName,
                ayahIndex: currentAyahIndex,
                ayahDisplayNum: ayahNum,
                date: new Date().toLocaleTimeString('ar-IQ')
            };
            const exists = favorites.some(f => f.surahNum == newFav.surahNum && f.ayahIndex == newFav.ayahIndex);
            if(!exists) {
                favorites.unshift(newFav);
                localStorage.setItem('quran_favorites', JSON.stringify(favorites));
                alert(`âœ… Ø´ÙˆÛÙ†ÛŒ Ú¯Û•ÛŒØ´ØªÙ† Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§:\n${currentSurahName} - Ø¦Ø§ÛŒÛ•ØªÛŒ ${ayahNum}`);
            } else { alert("âš ï¸ Ø¦Û•Ù… Ø´ÙˆÛÙ†Û• Ù¾ÛØ´ØªØ± Ù¾Ø§Ø´Û•Ú©Û•ÙˆØª Ú©Ø±Ø§ÙˆÛ•"); }
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('quran_history') || '[]');
            historyList.innerHTML = history.length ? '' : '<div style="text-align:center; color:#999;">Ù‡ÛŒÚ† Ù…ÛÚ˜ÙˆÙˆÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</div>';
            history.forEach(h => {
                historyList.innerHTML += `<div class="menu-item" onclick="loadSurah(${h.number}); toggleMenu();"><div class="item-info"><span>ğŸ“– ${h.name}</span><span class="item-date">${h.date}</span></div></div>`;
            });
        }

        function loadFavorites() {
            let favorites = JSON.parse(localStorage.getItem('quran_favorites') || '[]');
            favoritesList.innerHTML = favorites.length ? '' : '<div style="text-align:center; color:#999;">Ù‡ÛŒÚ† Ø¯ÚµØ®ÙˆØ§Ø²ÛÚ© Ù†ÛŒÛŒÛ•</div>';
            favorites.forEach((f, index) => {
                favoritesList.innerHTML += `<div class="menu-item"><div class="item-info" onclick="restoreSession(${f.surahNum}, ${f.ayahIndex}); toggleMenu();"><span>â¤ï¸ ${f.surahName} - Ø¦Ø§ÛŒÛ•ØªÛŒ ${f.ayahDisplayNum}</span><span class="item-date">${f.date}</span></div><span class="delete-item" onclick="deleteFavorite(${index})">ğŸ—‘ï¸</span></div>`;
            });
        }

        function deleteFavorite(index) {
            let favorites = JSON.parse(localStorage.getItem('quran_favorites') || '[]');
            favorites.splice(index, 1);
            localStorage.setItem('quran_favorites', JSON.stringify(favorites));
            loadFavorites();
        }

        async function restoreSession(surahNum, ayahIdx) {
            surahSelect.value = surahNum;
            await loadSurah(surahNum);
            currentAyahIndex = ayahIdx;
            prepareCurrentAyah();
            setTimeout(() => {
                const el = document.getElementById(`ayah-${ayahIdx}`);
                if(el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.style.backgroundColor = "#fff3cd";
                    setTimeout(() => el.style.backgroundColor = "transparent", 2000);
                }
            }, 500);
        }

        // ==========================================
        // Quran & API Logic
        // ==========================================
        async function fetchSurahList() {
            try {
                const response = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await response.json();
                surahSelect.innerHTML = '';
                data.data.forEach(surah => {
                    const option = document.createElement('option');
                    option.value = surah.number;
                    option.text = `${surah.number}. ${surah.name}`;
                    if(surah.number === 1) option.selected = true;
                    surahSelect.appendChild(option);
                });
            } catch (error) { console.log("Offline mode"); }
        }

        async function loadSurah(surahNumber) {
            surahNumber = parseInt(surahNumber);
            currentSurahNumber = surahNumber;
            const option = surahSelect.querySelector(`option[value="${surahNumber}"]`);
            if(option) {
                currentSurahName = option.text.split('. ')[1];
                addToHistory(surahNumber, currentSurahName);
            }
            if(surahNumber == 1) {
                allAyahs = fatihaData;
                renderSurah(1);
                currentAyahIndex = 0;
                prepareCurrentAyah();
                return;
            }
            quranDisplay.innerHTML = '<div style="text-align:center; margin-top:50px; color:#d4af37;">Ø¬Ø§Ø±ÛŒ Ù‡ÛÙ†Ø§Ù†ÛŒ Ø¦Ø§ÛŒÛ•ØªÛ•Ú©Ø§Ù†...</div>';
            try {
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/editions/quran-uthmani`);
                if(!response.ok) throw new Error("Blocked");
                const data = await response.json();
                allAyahs = data.data[0].ayahs;
                renderSurah(surahNumber);
                currentAyahIndex = 0;
                prepareCurrentAyah();
            } catch (error) {
                quranDisplay.innerHTML = `<div style="text-align:center; padding:20px;">âš ï¸ Ú©ÛØ´Û•ÛŒ Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØªØŒ ØªÚ©Ø§ÛŒÛ• Ø¯ÚµÙ†ÛŒØ§Ø¨Û•Ø±Û•ÙˆÛ• Ù„Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒÛ•Ú©Û•Øª.</div>`;
            }
        }

        function renderSurah(surahNum) {
            let html = "";
            if(surahNum != 1 && surahNum != 9) html += `<div class="basmala">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>`;
            allAyahs.forEach((ayah, aIndex) => {
                let text = ayah.text;
                if(surahNum != 1 && aIndex === 0) text = text.replace("Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", "").trim();
                html += `<span id="ayah-${aIndex}" class="ayah-container">`;
                text.split(' ').forEach((word, wIndex) => {
                    html += `<span id="word-${aIndex}-${wIndex}" class="word">${word} </span>`;
                });
                html += `<span class="ayah-number">${ayah.numberInSurah}</span></span> `;
            });
            quranDisplay.innerHTML = html;
        }

        function prepareCurrentAyah() {
            if(currentAyahIndex < allAyahs.length) {
                let text = allAyahs[currentAyahIndex].text;
                if(currentAyahIndex === 0 && allAyahs.length > 7 && allAyahs[0].text.includes("Ø¨ÙØ³Ù’Ù…Ù")) 
                     text = text.replace("Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", "").trim();
                currentWords = text.split(' ');
                currentWordIndex = 0;
                const el = document.getElementById(`ayah-${currentAyahIndex}`);
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function getSkeleton(text) {
            if (!text) return "";
            return text
                .replace(/[\u0610-\u061A\u064B-\u066F\u06D6-\u06DC\u06DF-\u06E8\u06EA-\u06ED]/g, '')
                .replace(/[Ø§Ø£Ø¥Ø¢Ù±Ù°]/g, '')
                .replace(/(Ù‰|ÙŠ|Ø¦)/g, 'ÙŠ')
                .replace(/(Ø©|Ù‡)/g, 'Ù‡')
                .replace(/(Ø¤|Ùˆ)/g, 'Ùˆ')
                .replace(/\s+/g, '')
                .trim();
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true; 
            recognition.lang = 'ar-SA';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => { 
                isListening = true; 
                micBtn.classList.add('listening'); 
                micBtn.innerHTML = "<span>â¹</span> ÙˆÛ•Ø³ØªØ§Ù†"; 
                captionBox.innerText = "Ú¯ÙˆÛØ¯Û•Ú¯Ø±ÛØª..."; 
                captionBox.style.color = "#27ae60"; 
            };
            
            recognition.onend = () => { 
                if (isListening) recognition.start(); 
                else { 
                    micBtn.classList.remove('listening'); 
                    micBtn.innerHTML = "<span>ğŸ¤</span> Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†"; 
                    captionBox.innerText = "ÙˆÛ•Ø³ØªØ§."; 
                    captionBox.style.color = "#555"; 
                } 
            };

            recognition.onresult = (event) => { 
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                captionBox.innerText = transcript;
                checkMatch(transcript); 
            };
        } else { alert("ØªÚ©Ø§ÛŒÛ• Google Chrome Ø¨Û•Ú©Ø§Ø±Ø¨Ù‡ÛÙ†Û•"); }

        function checkMatch(spokenText) {
            if(currentAyahIndex >= allAyahs.length) return;
            let spokenSkeleton = getSkeleton(spokenText);
            for (let i = 0; i < 3; i++) {
                let indexToCheck = currentWordIndex + i;
                if (indexToCheck >= currentWords.length) break;
                let targetWordRaw = currentWords[indexToCheck];
                let targetSkeleton = getSkeleton(targetWordRaw);
                if (spokenSkeleton.includes(targetSkeleton)) { 
                    for(let j = 0; j <= i; j++) activateWord(); 
                    return; 
                }
            }
        }

        function activateWord() {
            let el = document.getElementById(`word-${currentAyahIndex}-${currentWordIndex}`);
            if(el) { el.classList.add('active'); }
            currentWordIndex++; 
            if(currentWordIndex >= currentWords.length) nextAyah();
        }

        function nextAyah() {
            currentAyahIndex++; 
            captionBox.innerText = "..."; 
            if (currentAyahIndex < allAyahs.length) {
                prepareCurrentAyah();
            } else { 
                captionBox.innerText = "ØªÛ•ÙˆØ§Ùˆ Ø¨ÙˆÙˆØŒ Ø¯Û•Ú†ÛØªÛ• Ø³ÙˆØ±Û•ØªÛŒ Ø¯ÙˆØ§ØªØ±..."; 
                setTimeout(() => { 
                    let currentSurahId = parseInt(surahSelect.value); 
                    let nextSurahId = currentSurahId + 1; 
                    if(nextSurahId <= 114) { 
                        surahSelect.value = nextSurahId; 
                        loadSurah(nextSurahId); 
                    } else { 
                        captionBox.innerText = "Ù¾ÛŒØ±Û†Ø²Û•! Ù‡Û•Ù…ÙˆÙˆ Ù‚ÙˆØ±Ø¦Ø§Ù†Øª ØªÛ•ÙˆØ§Ùˆ Ú©Ø±Ø¯."; 
                        isListening = false; 
                        recognition.stop(); 
                    } 
                }, 1000); 
            }
        }

        function toggleListening() {
            if(isListening) { 
                isListening = false; 
                recognition.stop(); 
            } else { 
                recognition.start(); 
            }
        }
    </script>
</body>
</html>
