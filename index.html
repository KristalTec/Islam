<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Û•Ø±Û•Ú©ÛŒ - Ú•Û•Ù…Û•Ø²Ø§Ù† Ú©Û•Ø±ÛŒÙ…</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================= R A M A D A N   T H E M E ================= */
        * { -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        
        :root { 
            --bg-deep: #0f172a;      /* Deep Night Blue */
            --bg-card: rgba(30, 41, 59, 0.7); /* Glassy Card */
            --gold: #fbbf24;         /* Bright Gold */
            --gold-dark: #b45309;    /* Dark Gold/Bronze */
            --text-main: #f1f5f9;    /* White-ish */
            --text-muted: #94a3b8;   /* Light Grey */
            --highlight: #10b981;    /* Emerald Green */
            --nav-bg: rgba(15, 23, 42, 0.95);
            --border-glass: 1px solid rgba(251, 191, 36, 0.2);
        }

        body { 
            font-family: 'Amiri', serif; 
            background: linear-gradient(135deg, #020024 0%, #090979 35%, #00d4ff 100%);
            background-image: url('https://www.transparenttextures.com/patterns/arabesque.png'), linear-gradient(to bottom, #0f172a, #1e1b4b);
            margin: 0; 
            padding: 0; 
            display: flex; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden; 
            color: var(--text-main);
        }

        /* Container with Glass Effect */
        .app-container { 
            width: 100%; 
            max-width: 600px; 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            height: 100%; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
            border-left: var(--border-glass);
            border-right: var(--border-glass);
        }
        
        /* Header */
        .header { 
            background: rgba(15, 23, 42, 0.8); 
            padding: 15px; 
            border-bottom: 1px solid rgba(251, 191, 36, 0.3); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: var(--gold); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            z-index: 50; 
        }
        .header-btn { cursor: pointer; font-size: 24px; padding: 5px; transition: 0.3s; position: relative; text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
        .header-btn:hover { transform: scale(1.1); color: #fff; }
        .notif-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 1px solid white; display: none; box-shadow: 0 0 5px red; }
        
        /* Content */
        .content { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; scroll-behavior: smooth; }
        
        /* Hero Card - Ramadan Style */
        .hero-card { 
            background: linear-gradient(135deg, #b45309, #fbbf24); 
            color: #0f172a; 
            padding: 25px; 
            border-radius: 20px; 
            text-align: center; 
            margin-bottom: 25px; 
            box-shadow: 0 10px 25px rgba(251, 191, 36, 0.2); 
            position: relative; 
            overflow: hidden; 
            border: 2px solid rgba(255,255,255,0.2);
        }
        .hero-title { font-size: 28px; margin-bottom: 5px; position: relative; z-index: 2; font-weight: bold; text-shadow: 0 1px 2px rgba(255,255,255,0.4); }
        .hero-date { font-size: 16px; opacity: 0.9; position: relative; z-index: 2; font-weight: bold; }
        .hero-pattern { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.2; 
            background-image: url('https://www.transparenttextures.com/patterns/arabesque.png'); 
        }
        /* Lantern Decoration CSS */
        .lantern-deco {
            position: absolute; top: -10px; right: 20px; font-size: 50px; opacity: 0.3; transform: rotate(15deg);
        }

        /* Menu Grid */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .card { 
            background: var(--bg-card); 
            padding: 20px; 
            border-radius: 16px; 
            text-align: center; 
            border: var(--border-glass); 
            transition: 0.3s; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            text-decoration: none; 
            color: var(--text-main); 
        }
        .card:hover { transform: translateY(-5px); background: rgba(251, 191, 36, 0.1); border-color: var(--gold); }
        .card:active { transform: scale(0.95); }
        .card-icon { font-size: 32px; filter: drop-shadow(0 0 5px rgba(251,191,36,0.5)); }
        .card-title { font-weight: bold; font-size: 18px; color: var(--gold); }

        /* Feed System */
        .feed-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .feed-title { font-size: 18px; font-weight: bold; color: var(--gold); display: flex; align-items: center; gap: 8px; }
        .live-indicator { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: blink 1.5s infinite; box-shadow: 0 0 8px #ef4444; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        
        .feed-card { 
            background: rgba(30, 41, 59, 0.6); 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            border: 1px solid rgba(255,255,255,0.05); 
            transition: 0.5s; 
            position: relative; 
            overflow: hidden; 
            animation: slideIn 0.5s ease; 
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .feed-tag { position: absolute; top: 10px; left: 10px; font-size: 10px; padding: 4px 10px; border-radius: 20px; color: #fff; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tag-ayah { background: linear-gradient(45deg, #10b981, #059669); } 
        .tag-hadith { background: linear-gradient(45deg, #3b82f6, #2563eb); } 
        .tag-dua { background: linear-gradient(45deg, #f59e0b, #d97706); } 
        .tag-info { background: linear-gradient(45deg, #8b5cf6, #7c3aed); } 
        .tag-name { background: linear-gradient(45deg, #ef4444, #dc2626); } 
        
        .feed-content { font-size: 17px; line-height: 1.8; color: #e2e8f0; margin-top: 15px; text-align: justify; text-shadow: 0 1px 1px rgba(0,0,0,0.5); }
        .feed-source { font-size: 12px; color: #94a3b8; margin-top: 12px; display: block; font-style: italic; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 8px; }
        
        /* Moon Loader */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--gold); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Modals & Library */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; color: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid var(--gold); animation: popUp 0.3s ease; position: relative; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 30px rgba(251, 191, 36, 0.2); }
        .full-screen-modal { width: 100%; height: 100%; max-width: 600px; max-height: 100%; border-radius: 0; border: none; padding: 0; display: flex; flex-direction: column; background: #0f172a; }
        
        /* Library Specific Styles */
        .library-header { background: #1e293b; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 10; }
        .back-btn { font-size: 24px; cursor: pointer; color: var(--gold); }
        .search-container { width: 100%; position: relative; }
        .search-input { width: 100%; padding: 12px 15px; padding-right: 35px; border-radius: 25px; border: 1px solid #334155; background: #0f172a; color: white; font-family: 'Amiri', serif; outline: none; transition: 0.3s; }
        .search-input:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(251, 191, 36, 0.1); }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #64748b; }
        .library-body { padding: 15px; overflow-y: auto; background: #0f172a; flex-grow: 1; }
        
        .book-item { background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; border: 1px solid transparent; }
        .book-item:hover { border-color: var(--gold); background: rgba(30, 41, 59, 0.8); }
        .book-thumb { width: 50px; height: 70px; background: linear-gradient(45deg, #b45309, #fbbf24); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #0f172a; font-size: 20px; box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
        .book-info { text-align: right; flex-grow: 1; }
        .book-title { font-weight: bold; color: var(--text-main); margin-bottom: 3px; font-size: 16px; }
        .book-author { font-size: 12px; color: #94a3b8; }
        .book-cat { font-size: 10px; background: #334155; padding: 2px 8px; border-radius: 10px; color: #cbd5e1; display: inline-block; margin-top: 5px; }
        .read-btn { background: var(--gold); color: #0f172a; padding: 5px 15px; border-radius: 15px; font-size: 12px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .read-btn:hover { background: #fff; box-shadow: 0 0 10px white; }

        /* Other Styles */
        .stat-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; color: #cbd5e1; }
        .user-list { max-height: 200px; overflow-y: auto; margin-top: 10px; text-align: right; border: 1px solid #334155; padding: 5px; border-radius: 5px; display: none; background: #0f172a; }
        .user-item { padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 5px; display: flex; align-items: center; font-size: 12px; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .user-details { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        .user-ip { font-family: monospace; color: #64748b; direction: ltr; font-size: 11px; }
        .user-loc { color: var(--gold); font-weight: bold; font-size: 10px; direction: ltr; }
        .gps-link { background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; text-decoration: none; font-size: 10px; margin-top: 2px; display: inline-block;}
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .dot.online { background: #10b981; box-shadow: 0 0 8px #10b981; }
        
        .history-list { max-height: 300px; overflow-y: auto; text-align: right; margin-top: 10px; }
        .history-item { background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 8px; border-radius: 8px; border-right: 3px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: bold; font-size: 16px; color: var(--text-main); }
        .h-time { font-size: 11px; color: #94a3b8; }
        .clear-btn { background: #ef4444; color: white; border: none; padding: 5px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; margin-top: 10px; }
        
        .notif-toggle-btn { padding: 10px; font-size: 14px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; text-align: center; font-weight: bold; width: 100%; transition: 0.3s; border: 1px solid transparent; }
        .notif-enabled { background: rgba(16, 185, 129, 0.2); color: #34d399; border-color: #10b981; }
        .notif-disabled { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        .social-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; }
        .social-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .social-btn img { width: 22px; height: 22px; filter: brightness(0) invert(1); }
        .social-btn:hover { transform: translateY(-3px); border-color: var(--gold); background: var(--gold); }
        .social-btn:hover img { filter: none; }
        
        /* Navigation */
        .bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--nav-bg); height: 75px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); z-index: 100; backdrop-filter: blur(10px); }
        .nav-item { text-decoration: none; display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 12px; gap: 6px; transition: 0.3s; width: 33.33%; padding: 10px; border-radius: 10px; }
        .nav-item.active { color: var(--gold); font-weight: bold; background: rgba(251, 191, 36, 0.1); }
        .nav-icon { font-size: 24px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .nav-item:active { transform: scale(0.9); }
        .admin-badge { background: #ef4444; color: white; padding: 2px 5px; border-radius: 4px; font-size: 10px; display: none; box-shadow: 0 0 5px red; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="app-container">
        <audio id="notif-sound" src="https://www.islamcan.com/audio/adhan/bismillah.mp3" preload="auto"></audio>

        <div class="header">
            <div class="icon-group">
                <div class="header-btn" onclick="openSettings()" title="Ú•ÛÚ©Ø®Ø³ØªÙ†">âš™ï¸</div>
                <div class="header-btn" onclick="openHistory()" title="Ù…ÛÚ˜ÙˆÙˆ">
                    ğŸ•’
                    <span class="notif-badge" id="history-badge"></span>
                </div>
            </div>
            <div style="font-weight:bold; font-size:18px; cursor:pointer; text-shadow: 0 0 5px rgba(251, 191, 36, 0.5);" onclick="triggerAdminLogin()">
                Islam Online <span id="admin-indicator" class="admin-badge">Admin</span>
            </div>
            <div class="header-btn" onclick="triggerManualUpdate()" title="Ù†ÙˆÛÚ©Ø±Ø¯Ù†Û•ÙˆÛ•">ğŸ”ƒ</div>
        </div>

        <div class="content">
            <div class="hero-card">
                <div class="hero-pattern"></div>
                <div class="lantern-deco">ğŸŒ™</div>
                <div class="hero-title">Ú•Û•Ù…Û•Ø²Ø§Ù† Ù¾ÛŒØ±Û†Ø²</div>
                <div class="hero-date" id="current-date">...</div>
            </div>

            <div class="menu-grid">
                <a href="quran.html" class="card">
                    <div class="card-icon">ğŸ“–</div>
                    <div class="card-title">Ù‚ÙˆØ±Ø¦Ø§Ù†</div>
                </a>
                <a href="library.html" class="card">
                    <div class="card-icon">ğŸ“š</div>
                    <div class="card-title">Ú©ØªÛØ¨Ø®Ø§Ù†Û•</div>
                </a>
                <a href="daily.html" class="card">
                    <div class="card-icon">ğŸ•Œ</div>
                    <div class="card-title">Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ù†Ú¯</div>
                </a>
                <a href="hadith.html" class="card">
                    <div class="card-icon">âœ¨</div>
                    <div class="card-title">ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•</div>
                </a>
            </div>

            <div class="feed-header">
                <div class="feed-title">
                    <span class="live-indicator"></span>
                    <span>Ø¨Ø§Ø¨Û•ØªÛ• Ù†ÙˆÛÚ©Ø§Ù†</span>
                </div>
                <span style="font-size:12px; color:#94a3b8;">Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†</span>
            </div>
            
            <div id="feed-container">
                <div class="loader"></div>
            </div>
            
            <div style="margin-top: 30px; text-align: center; color: #64748b; font-size: 12px; opacity: 0.6;">
                Made by Muhamad Ibrahim Rasul
            </div>
        </div>

        <div class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <span class="nav-icon">ğŸ </span>
                <span>Ø³Û•Ø±Û•Ú©ÛŒ</span>
            </a>
            <a href="library.html" class="nav-item">
                <span class="nav-icon">ğŸ“š</span>
                <span>Ú©ØªÛØ¨</span>
            </a>
            <a href="daily.html" class="nav-item">
                <span class="nav-icon">ğŸ•Œ</span>
                <span>Ø¨Ø§Ù†Ú¯</span>
            </a>
        </div>
    </div>

    <div id="libraryModal" class="modal">
        <div class="modal-content full-screen-modal">
            <div class="library-header">
                <div class="back-btn" onclick="closeLibrary()">â”</div>
                <div class="search-container">
                    <input type="text" id="book-search" class="search-input" placeholder="Ú¯Û•Ú•Ø§Ù† Ø¨Û† Ù†Ø§ÙˆÛŒ Ú©ØªÛØ¨..." oninput="filterBooks()">
                    <span class="search-icon">ğŸ”</span>
                </div>
            </div>
            <div class="library-body" id="book-list">
                </div>
        </div>
    </div>

    <div id="settingsModal" class="modal" onclick="closeModal(event, 'settingsModal')">
        <div class="modal-content">
            <h3 style="color:var(--gold); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">âš™ï¸ Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù†</h3>
            
            <div id="notif-toggle-btn" class="notif-toggle-btn notif-disabled" onclick="toggleNotifications()">
                ğŸ”” Ú©Ø±ØªÛ• Ø¨Ú©Û• Ø¨Û† Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù†
            </div>

            <div class="stat-row">
                <span>Ø³Û•Ø±Ø¯Ø§Ù†ÛŒ ØªÛ†:</span>
                <b id="visit-count" style="color:white;">0</b>
            </div>
            <div class="stat-row">
                <span>Ø¦Û†Ù†ÚµØ§ÛŒÙ† Ù„Û• Ø¬ÛŒÙ‡Ø§Ù†Ø¯Ø§:</span>
                <b id="active-count" style="color:var(--highlight);">...</b>
            </div>
            
            <div class="stat-row" style="background:rgba(255,255,255,0.05); border-radius:5px; margin-top:5px; font-size:10px;">
                <span>ID-ÛŒ Ø¦Ø§Ù…ÛØ±Û•Ú©Û•Øª:</span>
                <b id="my-device-id" style="font-family:monospace; color:#94a3b8;">...</b>
            </div>

            <div id="admin-section" style="display:none;">
                <div style="text-align:right; margin-top:15px; font-weight:bold; font-size:14px; color:#ef4444; border-top:1px dashed #334155; padding-top:10px;">
                    ğŸ”’ Ù¾Ø§Ù†ÛÚµÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†:
                </div>
                <div class="user-list" id="users-list-container" style="display:block;">
                    <div style="text-align:center; padding:10px; color:#94a3b8;">Ø¬Ø§Ø±ÛŒ Ø¯Û•Ú©Ø±ÛØª...</div>
                </div>
                <button onclick="logoutAdmin()" style="width:100%; margin-top:5px; background:#ef4444; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer; font-weight:bold;">Ú†ÙˆÙˆÙ†Û• Ø¯Û•Ø±Û•ÙˆÛ• Ù„Û• Ø¦Û•Ø¯Ù…ÛŒÙ†</button>
            </div>

            <div style="margin-top:20px; font-weight:bold; color:var(--gold); border-bottom: 1px solid rgba(255,255,255,0.1);">ğŸ“ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ</div>
            <div class="social-row" style="margin-top:10px;">
                <a href="https://facebook.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg"></a>
                <a href="https://instagram.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e7/Instagram_logo_2016.svg"></a>
                <a href="https://snapchat.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/en/c/c4/Snapchat_logo.svg"></a>
                <a href="https://tiktok.com" target="_blank" class="social-btn"><img src="https://upload.wikimedia.org/wikipedia/en/a/a9/TikTok_logo.svg"></a>
            </div>

            <button onclick="document.getElementById('settingsModal').style.display='none'" style="margin-top:20px; padding:8px 20px; background:var(--gold); color:#0f172a; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="historyModal" class="modal" onclick="closeModal(event, 'historyModal')">
        <div class="modal-content">
            <h3 style="color:var(--gold);">ğŸ•’ Ù…ÛÚ˜ÙˆÙˆÛŒ Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•</h3>
            <div id="history-list-container" class="history-list"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
                <button onclick="document.getElementById('historyModal').style.display='none'" style="padding:8px 20px; background:var(--gold); color:#0f172a; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // ğŸ”’ SECURITY CONFIGURATION
        // ===========================================
        const ALLOWED_DEVICE_ID = "u_enqmvr2ay"; 
        // ===========================================

        // Data DB
        const db = {
            hadiths: [
                "Ù¾ÛØºÛ•Ù…Ø¨Û•Ø± (Ø¯.Ø®) Ø¯Û•ÙÛ•Ø±Ù…ÙˆÛØª: Ø¨Ø§Ø´ØªØ±ÛŒÙ†ØªØ§Ù† Ø¦Û•ÙˆÛ•ÛŒÛ• Ú©Û• Ù‚ÙˆØ±Ø¦Ø§Ù† ÙÛØ± Ø¯Û•Ø¨ÛØª Ùˆ ÙÛØ±ÛŒ Ø®Û•ÚµÚ©ÛŒØ´ÛŒ Ø¯Û•Ú©Ø§Øª.", 
                "Ù¾ÛÚ©Û•Ù†ÛŒÙ† Ø¨Û• Ú•ÙˆÙˆÛŒ Ø¨Ø±Ø§Ú©Û•ØªØ¯Ø§ Ø³Û•Ø¯Û•Ù‚Û•ÛŒÛ•.", 
                "Ù¾Ø§Ú©ÙˆØ®Ø§ÙˆÛÙ†ÛŒ Ø¨Û•Ø´ÛÚ©Û• Ù„Û• Ø¦ÛŒÙ…Ø§Ù†.", 
                "Ú©Û•Ø³ÛÚ©ØªØ§Ù† Ø¦ÛŒÙ…Ø§Ù†ÛŒ ØªÛ•ÙˆØ§Ùˆ Ù†ÛŒÛŒÛ• ØªØ§ Ø¦Û•ÙˆÛ•ÛŒ Ø¨Û† Ø®Û†ÛŒ Ù¾ÛÛŒ Ø®Û†Ø´Û• Ø¨Û† Ø¨Ø±Ø§Ú©Û•Ø´ÛŒ Ù¾ÛÛŒ Ø®Û†Ø´ Ù†Û•Ø¨ÛØª.",
                "ÙˆØ´Û•ÛŒ Ù¾Ø§Ú© Ø³Û•Ø¯Û•Ù‚Û•ÛŒÛ•.",
                "Ø®ÙˆØ¯Ø§ Ø¬ÙˆØ§Ù†Û• Ùˆ Ø¬ÙˆØ§Ù†ÛŒ Ø®Û†Ø´Ø¯Û•ÙˆÛØª."
            ],
            duas: ["Ø±ÙØ¨ÙÙ‘Ù†ÙØ§ Ø¢ØªÙÙ†ÙØ§ ÙÙÙŠ Ø§Ù„Ø¯ÙÙ‘Ù†Ù’ÙŠÙØ§ Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙÙÙŠ Ø§Ù„Ø¢Ø®ÙØ±ÙØ©Ù Ø­ÙØ³ÙÙ†ÙØ©Ù‹", "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†ÙŠ Ø£Ø³Ø£Ù„Ùƒ Ø§Ù„Ù‡Ø¯Ù‰ ÙˆØ§Ù„ØªÙ‚Ù‰ ÙˆØ§Ù„Ø¹ÙØ§Ù ÙˆØ§Ù„ØºÙ†Ù‰", "ÙŠØ§ Ù…Ù‚Ù„Ø¨ Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø«Ø¨Øª Ù‚Ù„Ø¨ÙŠ Ø¹Ù„Ù‰ Ø¯ÙŠÙ†Ùƒ", "Ø§Ù„Ù„Ù‡Ù… Ø¥Ù†Ùƒ Ø¹ÙÙˆ ØªØ­Ø¨ Ø§Ù„Ø¹ÙÙˆ ÙØ§Ø¹Ù Ø¹Ù†ÙŠ", "Ø±ÙØ¨ÙÙ‘ Ø§Ø´Ù’Ø±ÙØ­Ù’ Ù„ÙÙŠ ØµÙØ¯Ù’Ø±ÙÙŠ ÙˆÙÙŠÙØ³ÙÙ‘Ø±Ù’ Ù„ÙÙŠ Ø£ÙÙ…Ù’Ø±ÙÙŠ"],
            names: [{ name: "Ø§Ù„Ø±Ø­Ù…Ù†", meaning: "Ø¨Û•Ø®Ø´Ù†Ø¯Û•" }, { name: "Ø§Ù„Ø±Ø­ÙŠÙ…", meaning: "Ø¨Û•Ø¨Û•Ø²Û•ÛŒÛŒ" }, { name: "Ø§Ù„Ù…Ù„Ùƒ", meaning: "Ù¾Ø§Ø´Ø§" }, { name: "Ø§Ù„Ù‚Ø¯ÙˆØ³", meaning: "Ù¾Ø§Ú©" }, { name: "Ø§Ù„Ø³Ù„Ø§Ù…", meaning: "Ø¦Ø§Ø´ØªÛŒ" }],
            info: ["ÛŒÛ•Ú©Û•Ù… Ù…Ø²Ú¯Û•ÙˆØª Ù„Û• Ø¦ÛŒØ³Ù„Ø§Ù…Ø¯Ø§ Ù…Ø²Ú¯Û•ÙˆØªÛŒ Ù‚ÙˆØ¨Ø§Ø¦Û•.", "Ù‚ÙˆØ±Ø¦Ø§Ù†ÛŒ Ù¾ÛŒØ±Û†Ø² Ù„Û• Ù¡Ù¡Ù¤ Ø³ÙˆØ±Û•Øª Ù¾ÛÚ©Ù‡Ø§ØªÙˆÙˆÛ•.", "Ø¯Ø±ÛÚ˜ØªØ±ÛŒÙ† Ø³ÙˆØ±Û•ØªÛŒ Ù‚ÙˆØ±Ø¦Ø§Ù† Ø³ÙˆØ±Û•ØªÛŒ Ø¨Û•Ù‚Û•Ø±Û•ÛŒÛ•.", "Ú©ÙˆØ±ØªØªØ±ÛŒÙ† Ø³ÙˆØ±Û•Øª Ø§Ù„Ú©ÙˆØ«Ø±Û•."]
        };

        // Book Library Data
        const booksDB = [
            { title: "ØªÛ•ÙØ³ÛŒØ±ÛŒ Ú•Ø§Ù…Ø§Ù†", author: "Ù…. Ø¦Û•Ø­Ù…Û•Ø¯ Ú©Ø§Ú©Û• Ù…Û•Ø­Ù…ÙˆØ¯", cat: "ØªÛ•ÙØ³ÛŒØ±" },
            { title: "Ù‚Û•ÚµØ§ÛŒ Ù…ÙˆØ³ÙˆÚµÙ…Ø§Ù†", author: "Ø³Û•Ø¹ÛŒØ¯ Ø¨Ù† Ø¹Û•Ù„ÛŒ", cat: "Ø¯ÙˆØ¹Ø§" },
            { title: "Ú˜ÛŒØ§Ù†Ù†Ø§Ù…Û•ÛŒ Ù¾ÛØºÛ•Ù…Ø¨Û•Ø±", author: "Ù…ÙˆØ¨Ø§Ø±Û•Ú©ÙÙˆØ±ÛŒ", cat: "Ø³ÛŒØ±Û•" },
            { title: "Ø±ÛŒØ§Ø¶ Ø§Ù„ØµØ§Ù„Ø­ÛŒÙ†", author: "ÛŒÙ…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÛŒ", cat: "ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•" },
            { title: "Ú†Û†Ù† Ù†ÙˆÛÚ˜ Ø¨Ú©Û•ÛŒÙ†ØŸ", author: "Ù…Ø§Ù…Û†Ø³ØªØ§ Ú©Ø±ÛÚ©Ø§Ø±", cat: "ÙÛŒÙ‚Ù‡Ù€" },
            { title: "Ù‡Û•Ú¯Ø¨Û•ÛŒ Ø¦ÛŒÙ…Ø§Ù†", author: "Ø¯. Ø¹Ø¨Ø¯Ø§Ù„Ù„Ø·ÛŒÙ", cat: "Ø¨ÛŒØ±ÙˆØ¨Ø§ÙˆÛ•Ú•" },
            { title: "Ù¾ÙˆØ®ØªÛ•ÛŒ ØªÛ•ÙØ³ÛŒØ±ÛŒ Ù‚ÙˆØ±Ø¦Ø§Ù†", author: "Ø¦ÛŒØ¨Ù† Ú©Û•Ø³ÛŒØ±", cat: "ØªÛ•ÙØ³ÛŒØ±" },
            { title: "Ú¯Û•Ø´Û•Ù¾ÛØ¯Ø§Ù†ÛŒ Ù…Ø±Û†ÛŒÛŒ Ù„Û• Ø¦ÛŒØ³Ù„Ø§Ù…Ø¯Ø§", author: "Ø¯. Ø§Ø¨Ø±Ø§Ù‡ÛŒÙ… ÙÙ‚ÛŒ", cat: "Ú¯Û•Ø´Û•Ù¾ÛØ¯Ø§Ù†" },
            { title: "40 ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•ÛŒ Ù†Û•ÙˆØ§ÙˆÛŒ", author: "ÛŒÙ…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÛŒ", cat: "ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•" },
            { title: "Ú˜Ù† Ùˆ Ù…ÛØ±Ø¯Ø§ÛŒÛ•ØªÛŒ", author: "Ø¯. Ù…Ø­Ù…Ø¯ Ø±Ø§ØªØ¨ Ø§Ù„Ù†Ø§Ø¨Ù„Ø³ÙŠ", cat: "Ú©Û†Ù…Û•ÚµØ§ÛŒÛ•ØªÛŒ" }
        ];

        // NEW: Load External Hadiths from JSON
        async function loadExternalHadiths() {
            try {
                const response = await fetch('hadiths.json');
                if (!response.ok) throw new Error("JSON not found");
                const jsonHadiths = await response.json();
                const formattedHadiths = jsonHadiths.map(h => {
                    // Update: Changed text color to white for dark theme
                    return `<div style="font-weight:bold; font-size:18px; color:var(--text-main); margin-bottom:5px;">${h.arabic}</div>
                            <div style="font-size:15px; color:#cbd5e1; border-top:1px dashed rgba(255,255,255,0.1); padding-top:5px;">${h.kurdish}</div>
                            <div style="font-size:10px; color:#94a3b8; text-align:left;">${h.bookName} - ${h.ref}</div>`;
                });
                db.hadiths = [...formattedHadiths, ...db.hadiths];
            } catch (e) {
                console.log("Using internal DB only");
            }
        }

        // Set Date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('ar-IQ', options);

        // Define My ID
        let myId = localStorage.getItem('unique_device_id');
        if (!myId) { myId = 'u_' + Math.random().toString(36).substr(2, 8); localStorage.setItem('unique_device_id', myId); }
        document.getElementById('my-device-id').innerText = myId;

        // UI Functions
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; updateStatsUI(); }
        function openHistory() { document.getElementById('historyModal').style.display = 'flex'; renderHistory(); }
        function closeModal(e, id) { if (e.target.id === id) { document.getElementById(id).style.display = 'none'; } }

        // ===========================================
        // LIBRARY FUNCTIONS
        // ===========================================
        function openLibraryModal(e) {
            e.preventDefault();
            document.getElementById('libraryModal').style.display = 'flex';
            renderBooks();
        }

        function closeLibrary() {
            document.getElementById('libraryModal').style.display = 'none';
        }

        function renderBooks(filterText = "") {
            const list = document.getElementById('book-list');
            list.innerHTML = "";
            
            const filtered = booksDB.filter(book => book.title.includes(filterText) || book.author.includes(filterText));
            
            if(filtered.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">Ù‡ÛŒÚ† Ú©ØªÛØ¨ÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•</div>';
                return;
            }

            filtered.forEach(book => {
                const div = document.createElement('div');
                div.className = 'book-item';
                div.innerHTML = `
                    <div class="book-thumb">ğŸ“–</div>
                    <div class="book-info">
                        <div class="book-title">${book.title}</div>
                        <div class="book-author">${book.author}</div>
                        <div class="book-cat">${book.cat}</div>
                    </div>
                    <button class="read-btn">Ø®ÙˆÛÙ†Ø¯Ù†Û•ÙˆÛ•</button>
                `;
                list.appendChild(div);
            });
        }

        function filterBooks() {
            const val = document.getElementById('book-search').value;
            renderBooks(val);
        }

        // ===========================================
        // ADMIN SYSTEM
        // ===========================================
        let adminClicks = 0;
        let isAdmin = localStorage.getItem('site_admin_access') === 'true';

        if(isAdmin && myId !== ALLOWED_DEVICE_ID) {
            logoutAdmin(false); 
        }

        if(isAdmin && myId === ALLOWED_DEVICE_ID) {
            document.getElementById('admin-section').style.display = 'block';
            document.getElementById('admin-indicator').style.display = 'inline-block';
        }

        function triggerAdminLogin() {
            adminClicks++;
            if(adminClicks === 5) {
                adminClicks = 0;
                if(isAdmin) return; 

                const pass = prompt("ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•:");
                if(pass === "SD@26cQcatggBBMD$531578FbnmfsWronsTyygsBc53&") { 
                    if (myId === ALLOWED_DEVICE_ID) {
                        localStorage.setItem('site_admin_access', 'true');
                        isAdmin = true;
                        document.getElementById('admin-section').style.display = 'block';
                        document.getElementById('admin-indicator').style.display = 'inline-block';
                        alert("Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª Ø¨Û•Ú•ÛØ² Ø¦Û•Ø¯Ù…ÛŒÙ† âœ…");
                        updateStatsUI();
                    } else {
                        alert("âš ï¸ Ù‡Û•ÚµÛ•: Ø¦Û•Ù… Ø¦Ø§Ù…ÛØ±Û• Ú•ÛÚ¯Û•Ù¾ÛØ¯Ø±Ø§Ùˆ Ù†ÛŒÛŒÛ• Ø¨Û† Ø¦Û•Ø¯Ù…ÛŒÙ†.");
                    }
                } else {
                    alert("ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ• âŒ");
                }
            }
        }

        function logoutAdmin(showAlert = true) {
            localStorage.setItem('site_admin_access', 'false');
            isAdmin = false;
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('admin-indicator').style.display = 'none';
            if(showAlert) {
                alert("Ù…Ø§ÚµØ¦Ø§ÙˆØ§ Ø¦Û•Ø¯Ù…ÛŒÙ† ğŸ‘‹");
                location.reload();
            }
        }

        // ===========================================
        // NOTIFICATIONS & FEED
        // ===========================================
        let isNotifActive = JSON.parse(localStorage.getItem('isNotifActive') || 'false');
        let feedData;
        try {
            feedData = JSON.parse(localStorage.getItem('islam_feed_data') || '[]');
        } catch (e) { feedData = []; }

        function updateNotifUI() {
            const btn = document.getElementById('notif-toggle-btn');
            if (isNotifActive) {
                btn.innerHTML = "ğŸ”• Ú©Ø±ØªÛ• Ø¨Ú©Û• Ø¨Û† Ù†Ø§Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù†";
                btn.className = "notif-toggle-btn notif-enabled";
            } else {
                btn.innerHTML = "ğŸ”” Ú©Ø±ØªÛ• Ø¨Ú©Û• Ø¨Û† Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù†";
                btn.className = "notif-toggle-btn notif-disabled";
            }
        }

        function toggleNotifications() {
            if (isNotifActive) {
                isNotifActive = false;
                localStorage.setItem('isNotifActive', 'false');
                alert("âŒ Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù† Ú•Ø§Ú¯ÛŒØ±Ø§");
                updateNotifUI();
            } else {
                const audio = document.getElementById('notif-sound');
                audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(e => {});
                if ("Notification" in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            isNotifActive = true;
                            localStorage.setItem('isNotifActive', 'true');
                            alert("âœ… Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù† Ú†Ø§Ù„Ø§Ú© Ú©Ø±Ø§");
                            updateNotifUI();
                        }
                    });
                }
            }
        }

        function saveFeed() { localStorage.setItem('islam_feed_data', JSON.stringify(feedData)); }
        
        async function loadInitialFeed() {
            // FIX: Load internal data even if external fails
            await loadExternalHadiths();
            const container = document.getElementById('feed-container');
            container.innerHTML = ''; 
            
            if(feedData && feedData.length > 0) {
                feedData.forEach(item => { renderCard(item.type, item.content, item.isNew); });
            } else {
                // Generate initial content if empty
                addCardToFeed('hadith', getRandom(db.hadiths), false, true);
                addCardToFeed('info', getRandom(db.info), false, true);
                await addAyahCard();
            }
            
            // Start live updates immediately
            startLiveUpdates();
        }

        function addCardToFeed(type, content, isNew = false, save = true) {
            renderCard(type, content, isNew);
            if (save) {
                feedData.unshift({ type, content, isNew });
                if(feedData.length > 50) feedData.pop(); 
                saveFeed();
            }
        }

        function renderCard(type, content, isNew) {
            try {
                const container = document.getElementById('feed-container');
                // Remove loader if present
                if(container.querySelector('.loader')) container.innerHTML = '';

                const div = document.createElement('div');
                div.className = 'feed-card';
                let tagHTML = '', sourceHTML = '', displayContent = content;
                
                if(!content) return;

                if (type === 'hadith') { tagHTML = '<span class="feed-tag tag-hadith">ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•</span>'; sourceHTML = 'Ù¾ÛØºÛ•Ù…Ø¨Û•Ø± (Ø¯.Ø®) Ø¯Û•ÙÛ•Ø±Ù…ÙˆÛØª'; } 
                else if (type === 'dua') { tagHTML = '<span class="feed-tag tag-dua">Ø¯ÙˆØ¹Ø§ÛŒ Ú•Û†Ú˜</span>'; sourceHTML = 'Ø¯ÙˆØ¹Ø§ Ùˆ Ù¾Ø§Ú•Ø§Ù†Û•ÙˆÛ•'; } 
                else if (type === 'name') { 
                    tagHTML = '<span class="feed-tag tag-name">Ù†Ø§ÙˆÛŒ Ø®ÙˆØ§ÛŒ Ú¯Û•ÙˆØ±Û•</span>'; 
                    if(typeof content === 'object') {
                         displayContent = `<b>${content.name}</b>: ${content.meaning}`; 
                    } else { displayContent = content; }
                    sourceHTML = 'Ø¦Û•Ø³Ù…Ø§Ø¦ÛŒ Ø­ÙˆØ³Ù†Ø§'; 
                } 
                else if (type === 'info') { tagHTML = '<span class="feed-tag tag-info">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ</span>'; sourceHTML = 'Ø±Û†Ø´Ù†Ø¨ÛŒØ±ÛŒ Ø¦ÛŒØ³Ù„Ø§Ù…ÛŒ'; } 
                else if (type === 'ayah') { 
                    tagHTML = '<span class="feed-tag tag-ayah">Ø¦Ø§ÛŒÛ•ØªÛŒ Ú•Û†Ú˜</span>'; 
                    sourceHTML = content.source || 'Ù‚ÙˆØ±Ø¦Ø§Ù†ÛŒ Ù¾ÛŒØ±Û†Ø²'; 
                    displayContent = `"${content.text || content}"`; 
                }

                div.innerHTML = `${tagHTML}<div class="feed-content">${displayContent}</div><span class="feed-source">${sourceHTML} ${isNew ? 'â€¢ <span style="color:#ef4444">ØªØ§Ø²Û•</span>' : ''}</span>`;
                if (container.children.length > 0) { container.insertBefore(div, container.firstChild); } else { container.appendChild(div); }
            } catch (e) {
                console.log("Render error");
            }
        }

        async function addAyahCard() {
            try {
                const randomId = Math.floor(Math.random() * 6236) + 1;
                const r = await fetch(`https://api.alquran.cloud/v1/ayah/${randomId}/editions/quran-uthmani`);
                const d = await r.json();
                addCardToFeed('ayah', { text: d.data[0].text, source: `Ø³ÙˆØ±Ø© ${d.data[0].surah.name}` }, false, true);
            } catch(e) { 
                console.log("Ayah fetch error"); 
            }
        }

        function startLiveUpdates() { 
            // FIX: Ensure this runs and doesn't get stuck
            setInterval(() => { triggerManualUpdate(); }, 15000); 
        }

        function triggerManualUpdate() {
            try {
                const types = ['hadith', 'dua', 'name', 'info'];
                const type = types[Math.floor(Math.random() * types.length)];
                let content;
                if(type === 'name') content = getRandom(db.names); else content = getRandom(db[type + 's'] || db[type]); 
                addCardToFeed(type, content, true, true);
                
                if (isNotifActive) {
                    let notifTitle = "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù†ÙˆÛ", notifBody = "Ù†ÙˆÛÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•";
                    if(typeof content === 'string') notifBody = content.substring(0, 40) + "...";
                    else if(type === 'name') notifBody = content.name;
                    playNotification(notifTitle, notifBody);
                }
            } catch(e) { console.log("Update error"); }
        }

        function playNotification(title, body) {
            const audio = document.getElementById('notif-sound');
            audio.currentTime = 0; audio.play().catch(e => {});
            if("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
            if (Notification.permission === "granted") { new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/2884/2884657.png", requireInteraction: false }); }
        }
        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function renderHistory() {
            const container = document.getElementById('history-list-container');
            const history = JSON.parse(localStorage.getItem('quran_history') || '[]');
            container.innerHTML = history.length ? '' : '<div style="text-align:center; color:#999; padding:20px;">Ù‡ÛŒÚ† Ù…ÛÚ˜ÙˆÙˆÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</div>';
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div class="h-info"><span class="h-name">ğŸ“– ${item.name}</span><span class="h-time">${item.date}</span></div>`;
                container.appendChild(div);
            });
        }
        function clearHistory() { if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØŸ")) { localStorage.removeItem('quran_history'); renderHistory(); } }

        // ===========================================
        // REAL-TIME ONLINE SYSTEM
        // ===========================================
        if (!sessionStorage.getItem('session_counted')) {
            let visits = localStorage.getItem('total_site_visits') || 0;
            visits = parseInt(visits) + 1;
            localStorage.setItem('total_site_visits', visits);
            sessionStorage.setItem('session_counted', 'true');
        }
        document.getElementById('visit-count').innerText = localStorage.getItem('total_site_visits');

        const deviceType = /Mobi|Android/i.test(navigator.userAgent) ? "ğŸ“± Ù…Û†Ø¨Ø§ÛŒÙ„" : "ğŸ’» Ú©Û†Ù…Ù¾ÛŒÙˆØªÛ•Ø±";
        let myIP = "Loading...";
        let myLocation = "Ù†Û•Ø²Ø§Ù†Ø±Ø§Ùˆ";
        let myGPSLink = ""; 
        let onlineUsers = new Map();
        let socket;
        
        async function fetchIPandLocation() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                myIP = data.ip || "Unknown";
                myLocation = (data.city ? data.city : "") + " - " + (data.country_name ? data.country_name : "");
                if(myLocation === " - ") myLocation = "Ø´ÙˆÛÙ† Ù†Ø§Ø¯ÛŒØ§Ø±Û•";
            } catch (e) {
                myIP = "Unknown";
                myLocation = "Unknown Location";
            }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        myGPSLink = `https://www.google.com/maps?q=${lat},${lng}`;
                        if (socket && socket.readyState === WebSocket.OPEN) { broadcastPresence(); }
                    },
                    (error) => {}
                );
            }
            connectToSignalingServer();
        }

        function connectToSignalingServer() {
            const apiKey = 'VCXCEuvhGcBDP7XhiJJUDvR1e1D3eiVjgZ9VRiaV';
            const channelId = '1'; 
            socket = new WebSocket(`wss://demo.piesocket.com/v3/channel_${channelId}?api_key=${apiKey}&notify_self=1`);
            socket.onopen = () => { broadcastPresence(); setInterval(broadcastPresence, 3000); setInterval(cleanOfflineUsers, 5000); };
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'presence') {
                        onlineUsers.set(data.id, { ...data, lastSeen: Date.now() });
                        updateStatsUI();
                    }
                } catch (e) {}
            };
            socket.onclose = () => { setTimeout(connectToSignalingServer, 5000); };
        }

        function broadcastPresence() {
            if(socket && socket.readyState === WebSocket.OPEN) {
                const payload = JSON.stringify({ type: 'presence', id: myId, device: deviceType, ip: myIP, location: myLocation, gps: myGPSLink, timestamp: Date.now() });
                socket.send(payload);
            }
        }

        function cleanOfflineUsers() {
            const now = Date.now();
            let changed = false;
            onlineUsers.forEach((user, id) => { if (now - user.lastSeen > 10000) { onlineUsers.delete(id); changed = true; } });
            if (changed) updateStatsUI();
        }

        function updateStatsUI() {
            const list = document.getElementById('users-list-container');
            const countLabel = document.getElementById('active-count');
            list.innerHTML = '';
            let count = onlineUsers.size;
            if (count === 0) count = 1; 
            countLabel.innerText = count;
            if (!isAdmin) return; 

            const sortedUsers = Array.from(onlineUsers.values()).sort((a,b) => (a.id === myId ? -1 : 1));
            if (sortedUsers.length === 0) {
                 list.appendChild(createUserElement(myId, deviceType, myIP, myLocation, myGPSLink, true));
            } else {
                sortedUsers.forEach(user => {
                    const isMe = user.id === myId;
                    list.appendChild(createUserElement(user.id, user.device, user.ip, user.location, user.gps, isMe));
                });
            }
        }

        function createUserElement(id, device, ip, loc, gps, isMe) {
            const div = document.createElement('div');
            div.className = 'user-item';
            let gpsHTML = '';
            if (gps && gps.length > 5) { gpsHTML = `<a href="${gps}" target="_blank" class="gps-link">ğŸ“ Ú©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ù†Û•Ø®Ø´Û•</a>`; }
            div.innerHTML = `<div style="display:flex; align-items:center;"><span class="dot online"></span><span style="margin-right:10px; font-weight:bold;">${isMe ? 'ØªÛ† (Admin)' : 'Ù…ÛŒÙˆØ§Ù†'}</span></div><div class="user-details"><span style="font-size:10px; color:#94a3b8;">${device}</span><span class="user-loc">${loc || "Ù†Û•Ø²Ø§Ù†Ø±Ø§Ùˆ"}</span><span class="user-ip">${ip}</span>${gpsHTML}</div>`;
            return div;
        }

        // STARTUP
        loadInitialFeed();
        fetchIPandLocation(); 
        updateNotifUI();
    </script>
</body>
</html>
