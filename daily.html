<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú•Û†Ú˜Ø§Ù†Û•ÛŒ Ù…Ø³ÙˆÚµÙ…Ø§Ù† - Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ù†Ú¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #fffbf2; --border-color: #d4af37; --highlight-color: #27ae60; --text-color: #2c3e50; }
        body { font-family: 'Amiri', serif; background-color: #f8f9fa; margin: 0; padding: 20px; text-align: center; }
        
        .container { max-width: 600px; margin: 0 auto; background: var(--bg-color); border: 2px solid var(--border-color); border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .header { background: var(--border-color); color: white; padding: 15px; position: relative; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        
        .back-btn { position: absolute; left: 15px; top: 15px; background: white; color: var(--border-color); text-decoration: none; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; }

        /* Controls Area */
        .settings-box { background: rgba(255, 255, 255, 0.2); padding: 10px; border-radius: 10px; width: 90%; display: flex; flex-direction: column; gap: 10px; }
        
        select.custom-select { padding: 8px; border-radius: 20px; border: none; font-family: 'Amiri'; font-size: 14px; cursor: pointer; outline: none; background: white; color: var(--text-color); width: 100%; text-align: center; }
        
        .audio-controls { display: flex; align-items: center; justify-content: space-between; gap: 10px; background: white; padding: 5px 10px; border-radius: 20px; }
        
        /* Volume Slider */
        input[type=range] { width: 100px; cursor: pointer; }
        
        /* Mute Button */
        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; }

        optgroup { font-weight: bold; color: var(--border-color); }

        .section { padding: 20px; border-bottom: 1px solid #eee; }
        .prayer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        
        .prayer-card { background: white; padding: 12px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .prayer-card.active-prayer { border: 2px solid var(--highlight-color); background-color: #e8f8f5; transform: scale(1.02); box-shadow: 0 0 10px rgba(39, 174, 96, 0.2); }
        
        .prayer-name { font-weight: bold; color: var(--text-color); }
        .prayer-time { color: var(--border-color); font-weight: bold; background: #fffbf2; padding: 3px 8px; border-radius: 5px; }

        #adhan-alert { display: none; background-color: var(--highlight-color); color: white; padding: 15px; margin: 10px; border-radius: 8px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        .audio-permission { background: #ffeaa7; padding: 10px; font-size: 12px; color: #d35400; border-bottom: 1px solid #fdcb6e; display: none; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <audio id="adhan-audio" preload="auto">
            <source src="" type="audio/mpeg">
        </audio>

        <div class="audio-permission" id="audio-perm-btn" onclick="enableAudio()">
            ğŸ”Š ØªÚ©Ø§ÛŒÛ• Ø¦ÛØ±Û• Ø¯Ø§Ø¨Ú¯Ø±Û• Ø¨Û† Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ø¯Ù†ÛŒ Ø¯Û•Ù†Ú¯ÛŒ Ø¨Ø§Ù†Ú¯ (Ù¾ÛÙˆÛŒØ³ØªÛ•)
        </div>

        <div class="header">
            <a href="index.html" class="back-btn">â†ª</a>
            <span style="font-size:20px; font-weight:bold;">Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ù†Ú¯</span>
            
            <div class="settings-box">
                <select id="city-select" class="custom-select" onchange="changeCity()">
                    <optgroup label="Ø´Ø§Ø±Û• Ú¯Û•ÙˆØ±Û•Ú©Ø§Ù†">
                        <option value="Sulaymaniyah">Ø³Ù„ÛÙ…Ø§Ù†ÛŒ</option>
                        <option value="Erbil">Ù‡Û•ÙˆÙ„ÛØ±</option>
                        <option value="Duhok">Ø¯Ù‡Û†Ú©</option>
                        <option value="Kirkuk">Ú©Û•Ø±Ú©ÙˆÚ©</option>
                        <option value="Halabja">Ù‡Û•ÚµÛ•Ø¨Ø¬Û•</option>
                        <option value="Baghdad">Ø¨Û•ØºØ¯Ø§Ø¯</option>
                    </optgroup>
                    <optgroup label="Ù‚Û•Ø²Ø§ Ùˆ Ù†Ø§Ø­ÛŒÛ•Ú©Ø§Ù†">
                        <option value="Zakho">Ø²Ø§Ø®Û†</option>
                        <option value="Soran">Ø³Û†Ø±Ø§Ù†</option>
                        <option value="Kalar">Ú©Û•Ù„Ø§Ø±</option>
                        <option value="Ranya">Ú•Ø§Ù†ÛŒÛ•</option>
                        <option value="Chamchamal">Ú†Û•Ù…Ú†Û•Ù…Ø§Úµ</option>
                        <option value="Koya">Ú©Û†ÛŒÛ•</option>
                        <option value="Akre">Ø¦Ø§Ú©Ø±Û</option>
                        <option value="Darbandikhan">Ø¯Û•Ø±Ø¨Û•Ù†Ø¯ÛŒØ®Ø§Ù†</option>
                        <option value="Penjwen">Ù¾ÛÙ†Ø¬ÙˆÛÙ†</option>
                        <option value="Qaladze">Ù‚Û•ÚµØ§Ø¯Ø²Û</option>
                        <option value="Khanaqin">Ø®Ø§Ù†Û•Ù‚ÛŒÙ†</option>
                        <option value="Dukan">Ø¯ÙˆÚ©Ø§Ù†</option>
                        <option value="Rawanduz">Ú•Û•ÙˆØ§Ù†Ø¯Ø²</option>
                        <option value="Shaqlawa">Ø´Û•Ù‚ÚµØ§ÙˆÛ•</option>
                        <option value="Amadiya">Ø¦Ø§Ù…ÛØ¯ÛŒ</option>
                    </optgroup>
                </select>

                <div class="audio-controls">
                    <select id="audio-select" onchange="changeAdhanSound()" style="border:none; outline:none; font-family:'Amiri'; width:120px;">
                        <option value="makkah">Ø¨Ø§Ù†Ú¯ÛŒ Ù…Û•Ú©Ú©Û•</option>
                        <option value="madina">Ø¨Ø§Ù†Ú¯ÛŒ Ù…Û•Ø¯ÛŒÙ†Û•</option>
                        <option value="aqsa">Ø¨Ø§Ù†Ú¯ÛŒ Ù‚ÙˆØ¯Ø³</option>
                        <option value="mishary">Ù…Ø´Ø§Ø±ÛŒ Ø§Ù„Ø¹ÙØ§Ø³ÛŒ</option>
                        <option value="abdulbasit">Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø·</option>
                    </select>
                    
                    <input type="range" id="volume-control" min="0" max="1" step="0.1" value="1" onchange="changeVolume()" title="Ø¯Û•Ù†Ú¯">
                    
                    <button id="mute-btn" class="icon-btn" onclick="toggleMute()" title="Ø¨ÛØ¯Û•Ù†Ú¯/Ù†Û†ØªÛŒÙÛŒÚ©Û•ÛŒØ´Ù†">ğŸ””</button>
                </div>
            </div>
        </div>

        <div id="adhan-alert">
            ğŸ•Œ Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±! Ú©Ø§ØªÛŒ Ø¨Ø§Ù†Ú¯ÛŒ <span id="current-prayer-name">...</span>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="gregorian-date">...</span>
                <span id="hijri-date" style="color:var(--border-color);">...</span>
            </div>
            
            <div id="prayer-container" class="prayer-grid">
                <div style="color:#888;">Ø¬Ø§Ø±ÛŒ Ù‡ÛÙ†Ø§Ù†Û•...</div>
            </div>
        </div>

        <div class="section" style="border:none; font-size:12px; color:#999;">
            ØªÛØ¨ÛŒÙ†ÛŒ: Ø¨Û† Ø¨ÛŒØ³ØªÙ†ÛŒ Ø¨Ø§Ù†Ú¯ØŒ ØªÚ©Ø§ÛŒÛ• Ø¦Û•Ù… Ù¾Û•Ú•Û•ÛŒÛ• Ø¯Ø§Ù…Û•Ø®Û• (Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø¨Ú†ÛŒØªÛ• Ø¨Û•Ø±Ù†Ø§Ù…Û•ÛŒ ØªØ±).
        </div>
    </div>

    <script>
        // ==========================================
        // 1. Audio Sources & Setup
        // ==========================================
        const adhanSounds = {
            'makkah': 'https://www.islamcan.com/audio/adhan/azan2.mp3',
            'madina': 'https://www.islamcan.com/audio/adhan/azan3.mp3',
            'aqsa': 'https://www.islamcan.com/audio/adhan/azan6.mp3',
            'mishary': 'https://www.islamcan.com/audio/adhan/azan1.mp3',
            'abdulbasit': 'https://www.islamcan.com/audio/adhan/azan10.mp3'
        };

        const audioPlayer = document.getElementById('adhan-audio');
        let isMuted = false;
        let audioEnabled = false;

        // Restore Settings
        let currentCity = localStorage.getItem('selectedCity') || "Sulaymaniyah";
        let currentSound = localStorage.getItem('selectedSound') || "makkah";
        let savedVolume = localStorage.getItem('adhanVolume') || 1;

        // Initial UI Setup
        document.getElementById('city-select').value = currentCity;
        document.getElementById('audio-select').value = currentSound;
        document.getElementById('volume-control').value = savedVolume;
        audioPlayer.src = adhanSounds[currentSound];
        audioPlayer.volume = savedVolume;

        // Request Notification Permission
        if ("Notification" in window) {
            Notification.requestPermission();
        }

        function enableAudio() {
            audioPlayer.play().then(() => {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioEnabled = true;
                document.getElementById('audio-perm-btn').style.display = 'none';
                alert("âœ… Ø¯Û•Ù†Ú¯ Ú†Ø§Ù„Ø§Ú© Ú©Ø±Ø§");
            }).catch(e => console.log("User interaction required"));
        }

        document.addEventListener('click', () => {
            if(!audioEnabled) document.getElementById('audio-perm-btn').style.display = 'block';
        }, {once:true});

        // ==========================================
        // 2. Settings Functions
        // ==========================================
        function changeAdhanSound() {
            const selected = document.getElementById('audio-select').value;
            localStorage.setItem('selectedSound', selected);
            audioPlayer.src = adhanSounds[selected];
            // Play a short preview
            if(audioEnabled) {
                audioPlayer.play();
                setTimeout(() => { audioPlayer.pause(); audioPlayer.currentTime=0; }, 3000);
            }
        }

        function changeVolume() {
            const vol = document.getElementById('volume-control').value;
            localStorage.setItem('adhanVolume', vol);
            audioPlayer.volume = vol;
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if(isMuted) {
                btn.innerText = "ğŸ”•";
                btn.style.opacity = "0.5";
            } else {
                btn.innerText = "ğŸ””";
                btn.style.opacity = "1";
            }
        }

        // ==========================================
        // 3. API & Data Logic
        // ==========================================
        let todayPrayers = {}; 

        async function fetchIslamicData() {
            const cityContainer = document.getElementById('prayer-container');
            
            try {
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${currentCity}&country=Iraq&method=3`);
                const data = await response.json();
                
                if(data.code === 200) {
                    const timings = data.data.timings;
                    const date = data.data.date;

                    document.getElementById('gregorian-date').innerText = date.gregorian.date;
                    document.getElementById('hijri-date').innerText = `${date.hijri.day} ${date.hijri.month.en}`;

                    todayPrayers = {
                        'Fajr': timings.Fajr.split(' ')[0],
                        'Sunrise': timings.Sunrise.split(' ')[0],
                        'Dhuhr': timings.Dhuhr.split(' ')[0],
                        'Asr': timings.Asr.split(' ')[0],
                        'Maghrib': timings.Maghrib.split(' ')[0],
                        'Isha': timings.Isha.split(' ')[0]
                    };

                    const prayersDisplay = [
                        { key: 'Fajr', name: 'Ø¨Û•ÛŒØ§Ù†ÛŒ' },
                        { key: 'Sunrise', name: 'Ø®Û†Ø±Ú¾Û•ÚµØ§ØªÙ†' },
                        { key: 'Dhuhr', name: 'Ù†ÛŒÙˆÛ•Ú•Û†' },
                        { key: 'Asr', name: 'Ø¹Û•Ø³Ø±' },
                        { key: 'Maghrib', name: 'Ù…Û•ØºØ±ÛŒØ¨' },
                        { key: 'Isha', name: 'Ø¹ÛŒØ´Ø§' }
                    ];

                    let html = '';
                    prayersDisplay.forEach(p => {
                        html += `
                            <div class="prayer-card" id="card-${p.key}">
                                <span class="prayer-name">${p.name}</span>
                                <span class="prayer-time" dir="ltr">${todayPrayers[p.key]}</span>
                            </div>
                        `;
                    });
                    cityContainer.innerHTML = html;
                }
            } catch (error) {
                cityContainer.innerHTML = "<div style='color:red;'>Ú©ÛØ´Û• Ù„Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ù‡Û•ÛŒÛ•!</div>";
            }
        }

        function changeCity() {
            currentCity = document.getElementById('city-select').value;
            localStorage.setItem('selectedCity', currentCity);
            document.getElementById('prayer-container').innerHTML = "Ø¬Ø§Ø±ÛŒ Ú¯Û†Ú•ÛŒÙ†...";
            fetchIslamicData();
        }

        // ==========================================
        // 4. Time Check & Trigger Logic
        // ==========================================
        let lastPlayedTime = "";

        function checkTimeLoop() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;
            
            for (const [key, time] of Object.entries(todayPrayers)) {
                // Highlight Logic
                document.querySelectorAll('.prayer-card').forEach(c => c.classList.remove('active-prayer'));
                if (currentTime === time) {
                    const card = document.getElementById(`card-${key}`);
                    if(card) card.classList.add('active-prayer');
                }

                // Trigger Logic
                if (currentTime === time && key !== 'Sunrise') {
                    if (lastPlayedTime !== currentTime) {
                        triggerAdhan(key);
                        lastPlayedTime = currentTime;
                    }
                }
            }
        }

        function triggerAdhan(prayerKey) {
            const nameMap = {'Fajr':'Ø¨Û•ÛŒØ§Ù†ÛŒ', 'Dhuhr':'Ù†ÛŒÙˆÛ•Ú•Û†', 'Asr':'Ø¹Û•Ø³Ø±', 'Maghrib':'Ù…Û•ØºØ±ÛŒØ¨', 'Isha':'Ø¹ÛŒØ´Ø§'};
            const prayerName = nameMap[prayerKey];

            // 1. Show Visual Alert
            const alertBox = document.getElementById('adhan-alert');
            document.getElementById('current-prayer-name').innerText = prayerName;
            alertBox.style.display = 'block';

            // 2. Play Audio (If not muted)
            if (!isMuted) {
                audioPlayer.currentTime = 0;
                audioPlayer.play().catch(e => document.getElementById('audio-perm-btn').style.display = 'block');
            }

            // 3. Send Notification (If background)
            if (Notification.permission === "granted") {
                new Notification("Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ù†Ú¯", {
                    body: `Ø¨Ø§Ù†Ú¯ÛŒ ${prayerName} - Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±`,
                    icon: "https://cdn-icons-png.flaticon.com/512/2884/2884657.png"
                });
            }

            // Hide alert after 5 mins
            setTimeout(() => {
                alertBox.style.display = 'none';
                if(!isMuted) audioPlayer.pause();
            }, 300000);
        }

        // Start Loop
        setInterval(checkTimeLoop, 1000);
        fetchIslamicData();

    </script>
</body>
</html>
