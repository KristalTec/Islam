<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú•Û†Ú˜Ø§Ù†Û•ÛŒ Ù…Ø³ÙˆÚµÙ…Ø§Ù† - Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ù†Ú¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #fffbf2; --border-color: #d4af37; --highlight-color: #27ae60; --text-color: #2c3e50; }
        body { font-family: 'Amiri', serif; background-color: #f8f9fa; margin: 0; padding: 20px; text-align: center; }
        
        .container { max-width: 600px; margin: 0 auto; background: var(--bg-color); border: 2px solid var(--border-color); border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .header { background: var(--border-color); color: white; padding: 15px; font-size: 22px; font-weight: bold; position: relative; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 10px; }
        
        .back-btn { position: absolute; left: 15px; top: 18px; background: white; color: var(--border-color); text-decoration: none; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; }

        /* City Selector Styling */
        select#city-select {
            padding: 8px 15px; border-radius: 20px; border: none; font-family: 'Amiri'; font-size: 16px; cursor: pointer; outline: none; background: white; color: var(--text-color); box-shadow: 0 2px 5px rgba(0,0,0,0.2); width: 80%;
        }
        
        /* Group styling for dropdown */
        optgroup { font-weight: bold; color: var(--border-color); }

        .section { padding: 20px; border-bottom: 1px solid #eee; }
        .prayer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        
        .prayer-card { background: white; padding: 12px; border-radius: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        
        /* Active Prayer Style */
        .prayer-card.active-prayer { border: 2px solid var(--highlight-color); background-color: #e8f8f5; transform: scale(1.02); box-shadow: 0 0 10px rgba(39, 174, 96, 0.2); }
        
        .prayer-name { font-weight: bold; color: var(--text-color); }
        .prayer-time { color: var(--border-color); font-weight: bold; background: #fffbf2; padding: 3px 8px; border-radius: 5px; }

        /* Alert Box */
        #adhan-alert { display: none; background-color: var(--highlight-color); color: white; padding: 15px; margin: 10px; border-radius: 8px; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        /* Enable Audio Button */
        .audio-permission { background: #ffeaa7; padding: 10px; font-size: 12px; color: #d35400; border-bottom: 1px solid #fdcb6e; display: none; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <audio id="adhan-audio" preload="auto">
            <source src="https://www.islamcan.com/audio/adhan/azan1.mp3" type="audio/mpeg">
        </audio>

        <div class="audio-permission" id="audio-perm-btn" onclick="enableAudio()">
            ðŸ”Š ØªÚ©Ø§ÛŒÛ• Ø¦ÛŽØ±Û• Ø¯Ø§Ø¨Ú¯Ø±Û• Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø¯Û•Ù†Ú¯ÛŒ Ø¨Ø§Ù†Ú¯Û•Ú©Û• Ú©Ø§Ø± Ø¨Ú©Ø§Øª (Ù…Û•Ø±Ø¬ÛŒ ÙˆÛŽØ¨Ø³Ø§ÛŒØªÛ•)
        </div>

        <div class="header">
            <a href="index.html" class="back-btn">â†ª</a>
            <span>Ú©Ø§ØªÛ•Ú©Ø§Ù†ÛŒ Ø¨Ø§Ù†Ú¯</span>
            
            <select id="city-select" onchange="changeCity()">
                <optgroup label="Ø´Ø§Ø±Û• Ú¯Û•ÙˆØ±Û•Ú©Ø§Ù†">
                    <option value="Sulaymaniyah">Ø³Ù„ÛŽÙ…Ø§Ù†ÛŒ</option>
                    <option value="Erbil">Ù‡Û•ÙˆÙ„ÛŽØ±</option>
                    <option value="Duhok">Ø¯Ù‡Û†Ú©</option>
                    <option value="Kirkuk">Ú©Û•Ø±Ú©ÙˆÚ©</option>
                    <option value="Halabja">Ù‡Û•ÚµÛ•Ø¨Ø¬Û•</option>
                    <option value="Baghdad">Ø¨Û•ØºØ¯Ø§Ø¯</option>
                </optgroup>
                <optgroup label="Ù‚Û•Ø²Ø§ Ùˆ Ù†Ø§Ø­ÛŒÛ•Ú©Ø§Ù†">
                    <option value="Zakho">Ø²Ø§Ø®Û†</option>
                    <option value="Soran">Ø³Û†Ø±Ø§Ù†</option>
                    <option value="Kalar">Ú©Û•Ù„Ø§Ø±</option>
                    <option value="Ranya">Ú•Ø§Ù†ÛŒÛ•</option>
                    <option value="Chamchamal">Ú†Û•Ù…Ú†Û•Ù…Ø§Úµ</option>
                    <option value="Koya">Ú©Û†ÛŒÛ•</option>
                    <option value="Akre">Ø¦Ø§Ú©Ø±ÛŽ</option>
                    <option value="Darbandikhan">Ø¯Û•Ø±Ø¨Û•Ù†Ø¯ÛŒØ®Ø§Ù†</option>
                    <option value="Penjwen">Ù¾ÛŽÙ†Ø¬ÙˆÛŽÙ†</option>
                    <option value="Qaladze">Ù‚Û•ÚµØ§Ø¯Ø²ÛŽ</option>
                    <option value="Khanaqin">Ø®Ø§Ù†Û•Ù‚ÛŒÙ†</option>
                    <option value="Dukan">Ø¯ÙˆÚ©Ø§Ù†</option>
                    <option value="Rawanduz">Ú•Û•ÙˆØ§Ù†Ø¯Ø²</option>
                    <option value="Shaqlawa">Ø´Û•Ù‚ÚµØ§ÙˆÛ•</option>
                    <option value="Amadiya">Ø¦Ø§Ù…ÛŽØ¯ÛŒ</option>
                </optgroup>
            </select>
        </div>

        <div id="adhan-alert">
            ðŸ•Œ Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±! Ú©Ø§ØªÛŒ Ø¨Ø§Ù†Ú¯ÛŒ <span id="current-prayer-name">...</span>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="gregorian-date">...</span>
                <span id="hijri-date" style="color:var(--border-color);">...</span>
            </div>
            
            <div id="prayer-container" class="prayer-grid">
                <div style="color:#888;">Ø¬Ø§Ø±ÛŒ Ù‡ÛŽÙ†Ø§Ù†Û•...</div>
            </div>
        </div>

        <div class="section" style="border:none; font-size:12px; color:#999;">
            ØªÛŽØ¨ÛŒÙ†ÛŒ: Ø¦Û•Ú¯Û•Ø± Ù†Ø§ÙˆÚ†Û•Ú©Û•Øª Ù„Û• Ù„ÛŒØ³ØªÛ•Ú©Û• Ù†ÛŒÛŒÛ•ØŒ Ù†Ø²ÛŒÚ©ØªØ±ÛŒÙ† Ø´Ø§Ø± Ù‡Û•ÚµØ¨Ú˜ÛŽØ±Û•.
        </div>
    </div>

    <script>
        // Default City
        let currentCity = localStorage.getItem('selectedCity') || "Sulaymaniyah";
        document.getElementById('city-select').value = currentCity;

        // Store prayer times to check against
        let todayPrayers = {}; 
        let audioEnabled = false;

        // Function to fix audio policy
        function enableAudio() {
            const audio = document.getElementById('adhan-audio');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                audioEnabled = true;
                document.getElementById('audio-perm-btn').style.display = 'none';
                alert("âœ… Ø¯Û•Ù†Ú¯ÛŒ Ø¨Ø§Ù†Ú¯ Ú†Ø§Ù„Ø§Ú© Ú©Ø±Ø§");
            }).catch(e => console.log("Audio permission needed"));
        }

        // Check if user hasn't interacted yet
        document.addEventListener('click', () => {
            if(!audioEnabled) {
                document.getElementById('audio-perm-btn').style.display = 'block';
            }
        }, {once:true});


        async function fetchIslamicData() {
            const country = "Iraq";
            const cityContainer = document.getElementById('prayer-container');
            
            try {
                // Fetch Data based on selected city
                const response = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${currentCity}&country=${country}&method=3`);
                const data = await response.json();
                
                if(data.code === 200) {
                    const timings = data.data.timings;
                    const date = data.data.date;

                    document.getElementById('gregorian-date').innerText = date.gregorian.date;
                    document.getElementById('hijri-date').innerText = `${date.hijri.day} ${date.hijri.month.en}`;

                    // Save times
                    todayPrayers = {
                        'Fajr': timings.Fajr.split(' ')[0],
                        'Sunrise': timings.Sunrise.split(' ')[0],
                        'Dhuhr': timings.Dhuhr.split(' ')[0],
                        'Asr': timings.Asr.split(' ')[0],
                        'Maghrib': timings.Maghrib.split(' ')[0],
                        'Isha': timings.Isha.split(' ')[0]
                    };

                    const prayersDisplay = [
                        { key: 'Fajr', name: 'Ø¨Û•ÛŒØ§Ù†ÛŒ' },
                        { key: 'Sunrise', name: 'Ø®Û†Ø±Ú¾Û•ÚµØ§ØªÙ†' },
                        { key: 'Dhuhr', name: 'Ù†ÛŒÙˆÛ•Ú•Û†' },
                        { key: 'Asr', name: 'Ø¹Û•Ø³Ø±' },
                        { key: 'Maghrib', name: 'Ù…Û•ØºØ±ÛŒØ¨' },
                        { key: 'Isha', name: 'Ø¹ÛŒØ´Ø§' }
                    ];

                    let html = '';
                    prayersDisplay.forEach(p => {
                        html += `
                            <div class="prayer-card" id="card-${p.key}">
                                <span class="prayer-name">${p.name}</span>
                                <span class="prayer-time" dir="ltr">${todayPrayers[p.key]}</span>
                            </div>
                        `;
                    });
                    cityContainer.innerHTML = html;
                    
                    checkTimeLoop(); 
                }
            } catch (error) {
                cityContainer.innerHTML = "<div style='color:red;'>Ú©ÛŽØ´Û•ÛŒ Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛŽØª Ù‡Û•ÛŒÛ• ÛŒØ§Ù† Ø´Ø§Ø±Û•Ú©Û• Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•!</div>";
            }
        }

        function changeCity() {
            const select = document.getElementById('city-select');
            currentCity = select.value;
            localStorage.setItem('selectedCity', currentCity);
            document.getElementById('prayer-container').innerHTML = "Ø¬Ø§Ø±ÛŒ Ú¯Û†Ú•ÛŒÙ†...";
            fetchIslamicData();
        }

        // ==========================================
        // Adhan Logic
        // ==========================================
        function checkTimeLoop() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;
            
            for (const [key, time] of Object.entries(todayPrayers)) {
                if (currentTime === time && key !== 'Sunrise') {
                   triggerAdhan(key);
                }
                
                // Visual Highlight
                document.querySelectorAll('.prayer-card').forEach(c => c.classList.remove('active-prayer'));
                if (currentTime === time) {
                    const card = document.getElementById(`card-${key}`);
                    if(card) card.classList.add('active-prayer');
                }
            }
        }

        let lastPlayedTime = "";

        function triggerAdhan(prayerKey) {
            const now = new Date();
            const timeCode = `${now.getHours()}:${now.getMinutes()}`;

            if (lastPlayedTime !== timeCode) {
                lastPlayedTime = timeCode; 
                
                const alertBox = document.getElementById('adhan-alert');
                const nameMap = {'Fajr':'Ø¨Û•ÛŒØ§Ù†ÛŒ', 'Dhuhr':'Ù†ÛŒÙˆÛ•Ú•Û†', 'Asr':'Ø¹Û•Ø³Ø±', 'Maghrib':'Ù…Û•ØºØ±ÛŒØ¨', 'Isha':'Ø¹ÛŒØ´Ø§'};
                document.getElementById('current-prayer-name').innerText = nameMap[prayerKey];
                alertBox.style.display = 'block';

                const audio = document.getElementById('adhan-audio');
                audio.currentTime = 0;
                audio.play().catch(error => {
                    document.getElementById('audio-perm-btn').style.display = 'block';
                });

                setTimeout(() => {
                    alertBox.style.display = 'none';
                    audio.pause();
                }, 300000); 
            }
        }

        setInterval(checkTimeLoop, 1000);
        fetchIslamicData();

    </script>
</body>
</html>
